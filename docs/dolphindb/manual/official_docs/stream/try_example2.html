<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh" lang="zh" data-whc_version="26.0">
    <head><link rel="shortcut icon" href="../favicon.ico"/><link rel="icon" href="../favicon.ico"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="description" content="在量化交易中，因子计算是指根据一些预定义的规则或公式，从原始数据中提取出能够反映市场或个股特征的数值。本例中我们将以逐笔成交数据作为输入，对每一笔逐笔成交数据都响应一次，实时计算并输出过去 5 分钟主动成交量占比这一高频因子。 因子计算逻辑 主动成交占比即主动成交量占总成交量的比例，其计算公式如下： 其中 actVolumet 表示 t-window 时刻到 t ..."/><meta name="DC.rights.owner" content="(C) 版权 2024"/><meta name="copyright" content="(C) 版权 2024"/><meta name="generator" content="DITA-OT"/><meta name="DC.type" content="topic"/><meta name="DC.coverage" content=""/><meta name="DC.relation" content="../stream/str_intro.html"/><meta name="prodname" content="DolphinDB"/><meta name="brand" content="DolphinDB"/><meta name="DC.creator" content="DolphinDB"/><meta name="DC.publisher" content="DDB N/A DDB 200"/><meta name="DC.format" content="HTML5"/><meta name="DC.identifier" content="入门示例-02-实时计算过去-5-分钟主动成交量占比"/><title>入门示例 02 ：实时计算过去 5 分钟主动成交量占比</title><!--  Generated with Oxygen version 26.0, build number 2024012323.  --><meta name="wh-path2root" content="../"/><meta name="wh-toc-id" content="入门示例-02-实时计算过去-5-分钟主动成交量占比-d9529e3868"/><meta name="wh-source-relpath" content="stream/try_example2.dita"/><meta name="wh-out-relpath" content="stream/try_example2.html"/>

    <link rel="stylesheet" type="text/css" href="../oxygen-webhelp/app/commons.css?buildId=2024012323"/>
    <link rel="stylesheet" type="text/css" href="../oxygen-webhelp/app/topic.css?buildId=2024012323"/>

    <script src="../oxygen-webhelp/app/options/properties.js?buildId=20240704100525"></script>
    <script src="../oxygen-webhelp/app/localization/strings.js?buildId=2024012323"></script>
    <script src="../oxygen-webhelp/app/search/index/keywords.js?buildId=20240704100525"></script>
    <script defer="defer" src="../oxygen-webhelp/app/commons.js?buildId=2024012323"></script>
    <script defer="defer" src="../oxygen-webhelp/app/topic.js?buildId=2024012323"></script>
<link rel="stylesheet" type="text/css" href="../oxygen-webhelp/template/styles.css?buildId=2024012323"/><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script></head>

    <body id="入门示例-02-实时计算过去-5-分钟主动成交量占比" class="wh_topic_page frmBody">
        <a href="#wh_topic_body" class="sr-only sr-only-focusable">
            跳转到主要内容
        </a>
        
        
        
        
        <header class="navbar navbar-default wh_header">
    <div class="container-fluid">
        <div xmlns:whc="http://www.oxygenxml.com/webhelp/components" class="wh_header_flex_container navbar-nav navbar-expand-md navbar-dark">
            <div class="wh_logo_and_publication_title_container">
                <div class="wh_logo_and_publication_title">
                    
                    <a href="https://www.dolphindb.cn" class=" wh_logo d-none d-sm-block "><img src="../logo.png" alt="  DolphinDB 文档中心  "/></a>
                    <div class=" wh_publication_title "><a href="../index.html"><span class="booktitle">  <span class="ph mainbooktitle">DolphinDB 文档中心</span>  </span></a></div>
                    
                </div>
                
                
            </div>

            <div class="wh_top_menu_and_indexterms_link collapse navbar-collapse" id="wh_top_menu_and_indexterms_link">
                
                
                
                
            </div>
        <div class=" wh_search_input navbar-form wh_topic_page_search search " role="form">
            
            
            
            <form id="searchForm" method="get" role="search" action="../search.html"><div><input type="search" placeholder="搜索 " class="wh_search_textfield" id="textToSearch" name="searchQuery" aria-label="搜索查询" required="required"/><button type="submit" class="wh_search_button" aria-label="搜索"><span class="search_input_text">搜索</span></button></div></form>
            
            <script src="/vendors/react/umd/react.production.min.js" defer="defer"></script>
<script src="/vendors/react-dom/umd/react-dom.production.min.js" defer="defer"></script>
<script src="/vendors/dayjs/dayjs.min.js" defer="defer"></script>
<script src="/vendors/antd/dist/antd.min.js" defer="defer"></script>
<script src="/vendors/@ant-design/icons/dist/index.umd.min.js" defer="defer"></script>
<script src="/zh/index.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" defer="defer"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer="defer"><!--


--></script>

            
        </div></div>
    </div>
</header>
        
        
         
        
        
        
        <div class="container-fluid" id="wh_topic_container">
            <div class="row">

                <nav class="wh_tools d-print-none navbar-expand-md" aria-label="Tools">
                    
                    <div data-tooltip-position="bottom" class=" wh_breadcrumb "><ol class="d-print-none"><li><span class="home"><a href="../index.html"><span>主页</span></a></span></li><li><div class="topicref" data-id="chap7_tutorials_streaming"><div class="title"><a href="../stream/str_intro.html"><span class="keyword label">流数据</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 流数据引擎及流数据计算的基本概念</p></div></div></div></li><li><div class="topicref"><div class="title"><a href="../stream/try_example1.html">入门示例</a></div></div></li><li class="active"><div class="topicref" data-id="入门示例-02-实时计算过去-5-分钟主动成交量占比"><div class="title"><a href="../stream/try_example2.html">入门示例 02 ：实时计算过去 5 分钟主动成交量占比</a></div></div></li></ol></div>
                    
                    
                    
                    <div class="wh_right_tools">
                        <button class="wh_hide_highlight" aria-label="切换搜索突出显示" title="切换搜索突出显示"></button>
                        <button class="webhelp_expand_collapse_sections" data-next-state="collapsed" aria-label="折叠截面" title="折叠截面"></button>
                        
                        
                        
                        
                        <div class=" wh_print_link print d-none d-md-inline-block "><button onClick="window.print()" title="打印此页" aria-label="打印此页"></button></div>
                        
                        <button type="button" id="wh_toc_button" class="custom-toggler navbar-toggler collapsed wh_toggle_button navbar-light" aria-expanded="false" aria-label="Toggle publishing table of content" aria-controls="wh_publication_toc">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                    </div>
                    
                </nav>
            </div>
            
            
            
            
            <div class="wh_content_area">
                <div class="row">
                    
                        <nav id="wh_publication_toc" class="col-lg-3 col-md-3 col-sm-12 d-md-block d-none d-print-none" aria-label="Table of Contents Container">
                            <div id="wh_publication_toc_content">
		                        
                            	<div class=" wh_publication_toc " data-tooltip-position="right"><span class="expand-button-action-labels"><span id="button-expand-action" role="button" aria-label="Expand"></span><span id="button-collapse-action" role="button" aria-label="Collapse"></span><span id="button-pending-action" role="button" aria-label="Pending"></span></span><ul role="tree" aria-label="Table of Contents"><li role="treeitem"><div data-tocid="new_chap_about_sect_ddb_docs_intro-d9529e87" class="topicref" data-id="new_chap_about_sect_ddb_docs_intro" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../about/ddb_docs_intro.html" id="new_chap_about_sect_ddb_docs_intro-d9529e87-link">文档使用说明</a><div class="wh-tooltip"><p class="shortdesc">如何获取 DolphinDB 帮助信息</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="chap1_getstarted-d9529e140" class="topicref" data-id="chap1_getstarted" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action chap1_getstarted-d9529e140-link" class="wh-expand-btn"></span><div class="title"><a href="../getstarted/chap1_getstarted.html" id="chap1_getstarted-d9529e140-link"><span class="keyword label">快速上手</span></a><div class="wh-tooltip"><p class="shortdesc">如何快速部署 DolphinDB、建库建表、写入和查询数据</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="sectionddb_deployment-d9529e335" class="topicref" data-id="sectionddb_deployment" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action sectionddb_deployment-d9529e335-link" class="wh-expand-btn"></span><div class="title"><a href="../deploy/deploy_intro.html" id="sectionddb_deployment-d9529e335-link"><span class="keyword label">部署</span></a><div class="wh-tooltip"><p class="shortdesc">如何在不同的场景中部署 DolphinDB</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="new_chap_database_manage_new_chap_dbmanage_landing_page-d9529e2313" class="topicref" data-id="new_chap_database_manage_new_chap_dbmanage_landing_page" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action new_chap_database_manage_new_chap_dbmanage_landing_page-d9529e2313-link" class="wh-expand-btn"></span><div class="title"><a href="../db_distr_comp/cfg/db_intro.html" id="new_chap_database_manage_new_chap_dbmanage_landing_page-d9529e2313-link"><span class="keyword label">数据库</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 数据库的基本概念</p></div></div></div></li><li role="treeitem" aria-expanded="true"><div data-tocid="chap7_tutorials_streaming-d9529e3490" class="topicref" data-id="chap7_tutorials_streaming" data-state="expanded"><span role="button" tabindex="0" aria-labelledby="button-collapse-action chap7_tutorials_streaming-d9529e3490-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_intro.html" id="chap7_tutorials_streaming-d9529e3490-link"><span class="keyword label">流数据</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 流数据引擎及流数据计算的基本概念</p></div></div></div><ul role="group" class="navbar-nav nav-list"><li role="treeitem" aria-expanded="false"><div data-tocid="streamfunctions-d9529e3543" class="topicref" data-id="streamfunctions" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action streamfunctions-d9529e3543-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_funcs.html" id="streamfunctions-d9529e3543-link">功能简介</a></div></div></li><li role="treeitem" aria-expanded="true"><div data-tocid="tocId-d9529e3821" class="topicref" data-state="expanded"><span role="button" tabindex="0" aria-labelledby="button-collapse-action tocId-d9529e3821-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/try_example1.html" id="tocId-d9529e3821-link">入门示例</a></div></div><ul role="group" class="navbar-nav nav-list"><li role="treeitem"><div data-tocid="入门示例-01实时计算买卖价差-d9529e3822" class="topicref" data-id="入门示例-01实时计算买卖价差" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../stream/try_example1.html" id="入门示例-01实时计算买卖价差-d9529e3822-link">入门示例 01：实时计算买卖价差</a></div></div></li><li role="treeitem" class="active"><div data-tocid="入门示例-02-实时计算过去-5-分钟主动成交量占比-d9529e3868" class="topicref" data-id="入门示例-02-实时计算过去-5-分钟主动成交量占比" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../stream/try_example2.html" id="入门示例-02-实时计算过去-5-分钟主动成交量占比-d9529e3868-link">入门示例 02 ：实时计算过去 5 分钟主动成交量占比</a></div></div></li></ul></li><li role="treeitem" aria-expanded="false"><div data-tocid="内置流式计算算子-d9529e3914" class="topicref" data-id="内置流式计算算子" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action 内置流式计算算子-d9529e3914-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_operator.html" id="内置流式计算算子-d9529e3914-link"><span class="keyword label">内置流式计算算子</span></a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="streamingEngineTopic-d9529e4099" class="topicref" data-id="streamingEngineTopic" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action streamingEngineTopic-d9529e4099-link" class="wh-expand-btn"></span><div class="title"><a href="../funcs/themes/streamingEngine.html" id="streamingEngineTopic-d9529e4099-link"><span class="keyword label">内置流式计算引擎</span></a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="chap7_tutorials_streaming-d9529e4376" class="topicref" data-id="chap7_tutorials_streaming" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action chap7_tutorials_streaming-d9529e4376-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_join_engine.html" id="chap7_tutorials_streaming-d9529e4376-link"><span class="keyword label">内置多数据源流式关联引擎</span></a></div></div></li><li role="treeitem"><div data-tocid="streamha-d9529e4653" class="topicref" data-id="streamha" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_ha.html" id="streamha-d9529e4653-link"><span class="keyword label">流数据高可用</span></a></div></div></li><li role="treeitem"><div data-tocid="流计算状态监控-d9529e4700" class="topicref" data-id="流计算状态监控" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_monitor.html" id="流计算状态监控-d9529e4700-link">流计算状态监控</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="replay-d9529e4746" class="topicref" data-id="replay" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action replay-d9529e4746-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_replay.html" id="replay-d9529e4746-link"><span class="keyword label">历史数据回放</span></a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="流批一体功能-d9529e4931" class="topicref" data-id="流批一体功能" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action 流批一体功能-d9529e4931-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_batch.html" id="流批一体功能-d9529e4931-link"><span class="keyword label">流批一体</span></a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e5024" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e5024-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_api_python.html" id="tocId-d9529e5024-link">实时流数据接入</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="cep-d9529e5442" class="topicref" data-id="cep" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action cep-d9529e5442-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/cep.html" id="cep-d9529e5442-link">复杂事件处理（CEP）引擎</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e5995" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e5995-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/local_sub.html" id="tocId-d9529e5995-link">流处理结果交互方式</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e6184" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e6184-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_altair.html" id="tocId-d9529e6184-link">数据可视化工具</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e6277" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e6277-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/streaming_auto_sub.html" id="tocId-d9529e6277-link">金融场景应用案例</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e6969" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e6969-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/ddb_str_app_iot.html" id="tocId-d9529e6969-link">物联网场景应用案例</a></div></div></li></ul></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e7385" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e7385-link" class="wh-expand-btn"></span><div class="title"><a href="../db_distr_comp/db_oper/import_data.html" id="tocId-d9529e7385-link">数据迁移</a><div class="wh-tooltip"><p class="shortdesc">如何从不同数据源向 DolphinDB 迁移数据</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="chap7_tutorials_system_management-d9529e7812" class="topicref" data-id="chap7_tutorials_system_management" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action chap7_tutorials_system_management-d9529e7812-link" class="wh-expand-btn"></span><div class="title"><a href="../sys_man/om_intro.html" id="chap7_tutorials_system_management-d9529e7812-link"><span class="keyword label">系统运维</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 的系统运维功能及方法</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="about_language_resources-d9529e16490" class="topicref" data-id="about_language_resources" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action about_language_resources-d9529e16490-link" class="wh-expand-btn"></span><div class="title"><a href="../progr/progr_intro.html" id="about_language_resources-d9529e16490-link"><span class="keyword label">编程语言</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 编程基本概念与方法、SQL 在 DolphinDB 的应用</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="functions_references-d9529e26503" class="topicref" data-id="functions_references" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action functions_references-d9529e26503-link" class="wh-expand-btn"></span><div class="title"><a href="../funcs/funcs_intro.html" id="functions_references-d9529e26503-link"><span class="keyword label">函数参考</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 函数分类、语法、详解及示例</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="api_protocol-d9529e86456" class="topicref" data-id="api_protocol" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action api_protocol-d9529e86456-link" class="wh-expand-btn"></span><div class="title"><a href="../api/connapi_intro.html" id="api_protocol-d9529e86456-link"><span class="keyword label">连接器 &amp; API</span></a><div class="wh-tooltip"><p class="shortdesc">面向不同编程语言的 DolphinDB API 及连接器，相关协议和用法</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="chap6_plugin-d9529e91976" class="topicref" data-id="chap6_plugin" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action chap6_plugin-d9529e91976-link" class="wh-expand-btn"></span><div class="title"><a href="../plugins/plg_intro.html" id="chap6_plugin-d9529e91976-link"><span class="keyword label">插件</span></a><div class="wh-tooltip"><p class="shortdesc">多个应用场景的插件使用说明和插件开发指导</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="third_party-d9529e94749" class="topicref" data-id="third_party" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action third_party-d9529e94749-link" class="wh-expand-btn"></span><div class="title"><a href="../third_party.html" id="third_party-d9529e94749-link">第三方工具</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="about_tutorials-d9529e94980" class="topicref" data-id="about_tutorials" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action about_tutorials-d9529e94980-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/about_tutorials.html" id="about_tutorials-d9529e94980-link"><span class="keyword label">教程</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 产品使用教程</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e101769" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e101769-link" class="wh-expand-btn"></span><div class="title"><a href="../rn/server/3_00_1.html" id="tocId-d9529e101769-link">版本说明</a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 版本发布历史</p></div></div></div></li></ul></div>
		                        
                            </div>
                        </nav>
                    
                    
                    <div class="col-lg-7 col-md-9 col-sm-12" id="wh_topic_body">
                        <button id="wh_close_publication_toc_button" class="close-toc-button d-none" aria-label="Toggle publishing table of content" aria-controls="wh_publication_toc" aria-expanded="true">
                            <span class="close-toc-icon-container">
                                <span class="close-toc-icon"></span>     
                            </span>
                        </button>
                        <button id="wh_close_topic_toc_button" class="close-toc-button d-none" aria-label="Toggle topic table of content" aria-controls="wh_topic_toc" aria-expanded="true">
                            <span class="close-toc-icon-container">
                                <span class="close-toc-icon"></span>     
                            </span>
                        </button>
                        
                        <div class=" wh_topic_content body "><main role="main"><article class="- topic/topic topic" role="article" aria-labelledby="ariaid-title1">
    <h1 class="- topic/title title topictitle1" id="ariaid-title1">入门示例 02 ：实时计算过去 5 分钟主动成交量占比</h1>
    <article class="- topic/topic topic nested1" aria-labelledby="ariaid-title2" id="我们要计算什么">
        <h2 class="- topic/title title topictitle2" id="ariaid-title2">计算目标</h2>
        <div class="- topic/body body">
            <p class="- topic/p p">在量化交易中，因子计算是指根据一些预定义的规则或公式，从原始数据中提取出能够反映市场或个股特征的数值。本例中我们将以逐笔成交数据作为输入，对每一笔逐笔成交数据都响应一次，实时计算并输出过去
                5 分钟主动成交量占比这一高频因子。</p>
            <p class="- topic/p p">
                <strong class="+ topic/ph hi-d/b ph b">因子计算逻辑</strong>
            </p>
            <p class="- topic/p p">主动成交占比即主动成交量占总成交量的比例，其计算公式如下：</p>
            <br/><img class="- topic/image image" src="images/try_example2_1.png" height="171" width="394"/><br/>
            <p class="- topic/p p">其中 actVolumet 表示 t-window 时刻到 t 时刻区间内的主动成交量；totalVolumet 表示 t-window 时刻到 t
                时刻区间的总成交量；指示函数 I 含义如下：</p>
            <br/><img class="- topic/image image" src="images/try_example2_2.png" height="48" width="296"/><br/>
            <p class="- topic/p p">
                <strong class="+ topic/ph hi-d/b ph b">输入数据示例</strong>
            </p>
            <br/><img class="- topic/image image" src="images/try_example2_3.png"/><br/>
        </div>
    </article>
    <article class="- topic/topic topic nested1" aria-labelledby="ariaid-title3" id="动手实现">
        <h2 class="- topic/title title topictitle2" id="ariaid-title3">动手实现</h2>
        <div class="- topic/body body">
            <p class="- topic/p p">接下来我们会一步一步地在 DolphinDB 节点上模拟逐笔成交数据流和完成流式计算输出。完整脚本见附录。</p>
        </div>
        <article class="- topic/topic topic nested2" aria-labelledby="ariaid-title4" id="创建作为输入的流数据表">
            <h3 class="- topic/title title topictitle3" id="ariaid-title4">创建作为输入的流数据表</h3>
            <div class="- topic/body body">
                <p class="- topic/p p">首先创建一张共享流数据表 <em class="+ topic/ph hi-d/i ph i">trade</em> ，用于存储和发布逐笔成交数据：</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python">share(table=streamTable(<span class="hl-number">1</span>:<span class="hl-number">0</span>, `securityID`tradeTime`tradePrice`tradeQty`tradeAmount`buyNo`sellNo, [SYMBOL,TIMESTAMP,DOUBLE,INT,DOUBLE,LONG,LONG]), sharedName=`trade)</pre>
                <p class="- topic/p p">执行以上语句后，节点内存中会有一张表 <em class="+ topic/ph hi-d/i ph i">trade</em>，暂时没有写入任何一条数据。</p>
            </div>
        </article>
        <article class="- topic/topic topic nested2" aria-labelledby="ariaid-title5" id="创建作为输出的流数据表">
            <h3 class="- topic/title title topictitle3" id="ariaid-title5">创建作为输出的流数据表</h3>
            <div class="- topic/body body">
                <p class="- topic/p p">创建一张共享流数据表 <em class="+ topic/ph hi-d/i ph i">resultTable</em>，用于存储和发布因子计算结果：</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python">share(table=streamTable(<span class="hl-number">10000</span>:<span class="hl-number">0</span>, [<span class="hl-string">"securityID"</span>, <span class="hl-string">"tradeTime"</span>, <span class="hl-string">"factor"</span>], [SYMBOL, TIMESTAMP, DOUBLE]), sharedName=`resultTable) </pre>
                <p class="- topic/p p">执行以上语句后，节点内存中会有一张表 <em class="+ topic/ph hi-d/i ph i">resultTable</em>，暂时没有写入任何一条数据，我们希望将之后的计算结果实时写入到表
                        <em class="+ topic/ph hi-d/i ph i">resultTable</em> 中。</p>
            </div>
        </article>
        <article class="- topic/topic topic nested2" aria-labelledby="ariaid-title6" id="订阅流数据表">
            <h3 class="- topic/title title topictitle3" id="ariaid-title6">订阅流数据表</h3>
            <div class="- topic/body body">
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python"><strong class="hl-keyword">def</strong> factorCalFunc(msg){
  ...
}
subscribeTable(tableName=<span class="hl-string">"trade"</span>, actionName=<span class="hl-string">"factorCal"</span>, offset=-<span class="hl-number">1</span>, handler=factorCalFunc, msgAsTable=true, batchSize=<span class="hl-number">1</span>, throttle=<span class="hl-number">0.001</span>)</pre>
                <p class="- topic/p p">前三行是一段伪代码，假设系统上定义有名为 <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code> 的一元函数。执行第四行的
                        <code class="+ topic/ph pr-d/codeph ph codeph">subscribeTable</code> 函数，表示订阅流数据表 <em class="+ topic/ph hi-d/i ph i">trade</em>，并指定
                        <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code> 为数据处理方法，并分配一个后台线程用于不断地处理订阅到的新数据。那么，每当表
                        <em class="+ topic/ph hi-d/i ph i">trade</em> 被插入一批数据时，数据都会被发布到订阅端，订阅端的后台线程会收到这部分新增的数据，并以此作为输入调用函数
                        <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code> 。</p>
                <ul class="- topic/ul ul">
                    <li class="- topic/li li">
                        <p class="- topic/p p">tableName="trade" 表示订阅流数据表 <em class="+ topic/ph hi-d/i ph i">trade</em></p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p">actionName="factorCal" 表示订阅任务的名称，用户自定义即可，同一个节点上 tableName 和 actionName
                            的组合必须唯一</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p">offset=-1 表示从订阅之后表 <em class="+ topic/ph hi-d/i ph i">trade</em> 里新增的第一条数据开始消费</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p">handler=factorCalFunc 表示对订阅到的数据的处理方式</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p">msgAsTable=true 表示待处理的订阅到的数据是表，也就是这里 <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code> 函数的入参
                                <em class="+ topic/ph hi-d/i ph i">msg</em> 是表</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p">batchSize=1 和 throttle=0.001 共同指定了后台线程处理的频率，本例中的频率为任意有一条或多条待处理数据即调用一次处理函数
                                <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code></p>
                    </li>
                </ul>
                <p class="- topic/p p">那么，接下来的问题是如何实现因子计算函数 <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code>，来计算每支股票过去 5
                    分钟的总成交量以及主动成交量，进而得出主动成交量占比因子。</p>
            </div>
        </article>
        <article class="- topic/topic topic nested2" aria-labelledby="ariaid-title7" id="使用流计算引擎定义计算逻辑">
            <h3 class="- topic/title title topictitle3" id="ariaid-title7">使用流计算引擎定义计算逻辑</h3>
            <div class="- topic/body body">
                <p class="- topic/p p">我们从 <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code> 函数的一个错误实现讲起：</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python"><strong class="hl-keyword">def</strong> factorCalFunc(msg){
	tmp = select securityID, tradeTime, tmsum(tradeTime, iif(buyNo&gt;sellNo, tradeQty, <span class="hl-number">0</span>), <span class="hl-number">5</span>m)\tmsum(tradeTime, tradeQty, <span class="hl-number">5</span>m) <strong class="hl-keyword">as</strong> factor <strong class="hl-keyword">from</strong> msg context by securityID
	objByName(<span class="hl-string">"resultTable"</span>).append!(tmp)
}
subscribeTable(tableName=<span class="hl-string">"trade"</span>, actionName=<span class="hl-string">"factorCal"</span>, offset=-<span class="hl-number">1</span>, handler=factorCalFunc, msgAsTable=true, batchSize=<span class="hl-number">1</span>, throttle=<span class="hl-number">0.001</span>)</pre>
                <ul class="- topic/ul ul">
                    <li class="- topic/li li">
                        <p class="- topic/p p">msg 可以看做一个与* trade* 表结构相同的内存表</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p">objByName("resultTable").append!(tmp) 表示往结果表 <em class="+ topic/ph hi-d/i ph i">resultTable</em> 插入
                                <em class="+ topic/ph hi-d/i ph i">tmp</em> 表</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p"><em class="+ topic/ph hi-d/i ph i">tmp</em> 表通过 DolphinDB SQL 批计算得到：</p>
                        <ul class="- topic/ul ul">
                            <li class="- topic/li li">
                                <p class="- topic/p p">context by 是 DolphinDB 独有的功能，与 group by 类似，都对数据进行分组。不同的是，使用
                                    context by 对表 <em class="+ topic/ph hi-d/i ph i">msg</em> 分组后，返回的结果 <em class="+ topic/ph hi-d/i ph i">tmp</em> 的行数与 <em class="+ topic/ph hi-d/i ph i">msg</em>
                                    一致。此外， context by 可以和时间序列函数（如此处的 <code class="+ topic/ph pr-d/codeph ph codeph">tmsum</code>）一起使用，表示在
                                    securityID 分组内按记录的顺序逐行做滑动时间窗口聚合</p>
                            </li>
                            <li class="- topic/li li">
                                <p class="- topic/p p"><code class="+ topic/ph pr-d/codeph ph codeph">tmsum(tradeTime, tradeQty, 5m)</code> 表示以 tradeTime
                                    列为时间列，对每一行记录往前划定过去 5 分钟窗口，对窗口内所有记录的 tradeQty 求和，即过去五分钟的总成交量</p>
                            </li>
                            <li class="- topic/li li">
                                <p class="- topic/p p"><code class="+ topic/ph pr-d/codeph ph codeph">tmsum(tradeTime, iif(buyNo&gt;sellNo, tradeQty, 0),
                                        5m)</code> 表示以 tradeTime 列为时间列，对每一行记录往前划定过去 5 分钟窗口，对窗口内
                                        <code class="+ topic/ph pr-d/codeph ph codeph">buyNo&gt;sellNo</code> 的这部分记录的 tradeQty
                                    求和，即过去五分钟的主动成交量</p>
                            </li>
                        </ul>
                    </li>
                </ul>
                <p class="- topic/p p">
                    <strong class="+ topic/ph hi-d/b ph b">为什么上述的 factorCalFunc函数是一个错误示例？</strong>
                </p>
                <p class="- topic/p p">因为使用 <em class="+ topic/ph hi-d/i ph i">subscribeTable</em> 订阅之后每次调用 <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code> 只输入新增的
                        <em class="+ topic/ph hi-d/i ph i">trade</em> 表记录，而主动成交量因子依赖历史的若干行记录，但是在 <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code>
                    函数中并没有缓存和获取这部分历史记录，因此，订阅消费会因为没有考虑历史数据而输出错误的结果。我们手动构造数据并调用
                        <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code> 函数看一下效果，首先构造一批数据调用一次
                        <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code> 函数。</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python">// 定义结果表
share(table=streamTable(<span class="hl-number">10000</span>:<span class="hl-number">0</span>, [<span class="hl-string">"securityID"</span>, <span class="hl-string">"tradeTime"</span>, <span class="hl-string">"factor"</span>], [SYMBOL, TIMESTAMP, DOUBLE]), sharedName=`resultTable)
// 构造输入数据
input1 = table(<span class="hl-number">1</span>:<span class="hl-number">0</span>, `securityID`tradeTime`tradePrice`tradeQty`tradeAmount`buyNo`sellNo, [SYMBOL,TIMESTAMP,DOUBLE,INT,DOUBLE,LONG,LONG])
insert into input1 values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">30</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.85</span>, <span class="hl-number">100</span>, <span class="hl-number">3085</span>, <span class="hl-number">4951</span>, <span class="hl-number">0</span>)
insert into input1 values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">31</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.86</span>, <span class="hl-number">100</span>, <span class="hl-number">3086</span>, <span class="hl-number">4952</span>, <span class="hl-number">1</span>)
insert into input1 values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">32</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.85</span>, <span class="hl-number">200</span>, <span class="hl-number">6170</span>, <span class="hl-number">5001</span>, <span class="hl-number">5100</span>)
insert into input1 values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">33</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.83</span>, <span class="hl-number">100</span>, <span class="hl-number">3083</span>, <span class="hl-number">5202</span>, <span class="hl-number">5204</span>)
insert into input1 values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">34</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.82</span>, <span class="hl-number">300</span>, <span class="hl-number">9246</span>, <span class="hl-number">5506</span>, <span class="hl-number">5300</span>)
insert into input1 values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">35</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.82</span>, <span class="hl-number">500</span>, <span class="hl-number">15410</span>, <span class="hl-number">5510</span>, <span class="hl-number">5600</span>)
insert into input1 values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">36</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.87</span>, <span class="hl-number">800</span>, <span class="hl-number">24696</span>, <span class="hl-number">5700</span>, <span class="hl-number">5600</span>)
// 调用一次 factorCalFunc 函数
factorCalFunc(msg=input1)</pre>
                <p class="- topic/p p">执行下述语句查询结果表：</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python">select * <strong class="hl-keyword">from</strong> resultTable</pre>
                <p class="- topic/p p">返回结果如下，目前看起来一切正常：</p>
                <br/><img class="- topic/image image" src="images/try_example2_4.png"/><br/>
                <p class="- topic/p p">我们再构造 1 条数据，再调用一次 <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code> 函数：</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python">// 构造输入数据
input2 = table(<span class="hl-number">1</span>:<span class="hl-number">0</span>, `securityID`tradeTime`tradePrice`tradeQty`tradeAmount`buyNo`sellNo, [SYMBOL,TIMESTAMP,DOUBLE,INT,DOUBLE,LONG,LONG])
insert into input2 values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">36</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.87</span>, <span class="hl-number">800</span>, <span class="hl-number">24696</span>, <span class="hl-number">5700</span>, <span class="hl-number">5600</span>)
// 再调用一次 factorCalFunc 函数
factorCalFunc(msg=input2)</pre>
                <p class="- topic/p p">结果表如下，最后一行对应新增的这条 input2 数据的结果，factor 值明显错误：</p>
                <br/><img class="- topic/image image" src="images/try_example2_5.png"/><br/>
                <p class="- topic/p p">
                    <strong class="+ topic/ph hi-d/b ph b">如何实现正确的 factorCalFunc函数？</strong>
                </p>
                <p class="- topic/p p">流式处理中不断地处理增量数据，类似主动成交量因子这样的计算我们称为有状态计算，有状态计算需要用到历史的输入数据或者中间结果，我们可以在上文的
                        <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code> 函数的基础上进行复杂的改写以获取历史数据。但是，在 DolphinDB
                        中提供了更容易的实现方式——<strong class="+ topic/ph hi-d/b ph b">DolphinDB流计算引擎</strong>，
                        流计算引擎可以视作封装的独立计算黑盒，通过向其写入数据触发计算，并将计算结果输出到目标表，引擎内部缓存了需要用的历史数据或中间结果（也称为状态）。流计算引擎详细介绍见<a class="- topic/xref xref" href="../funcs/themes/streamingEngine.html">内置流式计算引擎</a> 。</p>
                <p class="- topic/p p">针对不同的场景有不同的流计算引擎，本例需要逐条分组响应计算并输出，所以应该用响应式状态引擎实现：</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python">createReactiveStateEngine(name=<span class="hl-string">"reactiveDemo"</span>, metrics=&lt;[tradeTime, tmsum(tradeTime, iif(buyNo&gt;sellNo, tradeQty, <span class="hl-number">0</span>), <span class="hl-number">5</span>m)\tmsum(tradeTime, tradeQty, <span class="hl-number">5</span>m)]&gt;, dummyTable=trade, outputTable=resultTable, keyColumn=<span class="hl-string">"securityID"</span>)

<strong class="hl-keyword">def</strong> factorCalFunc(msg){
    getStreamEngine(<span class="hl-string">"reactiveDemo"</span>).append!(msg)
}
subscribeTable(tableName=<span class="hl-string">"trade"</span>, actionName=<span class="hl-string">"factorCal"</span>, offset=-<span class="hl-number">1</span>, handler=factorCalFunc, msgAsTable=true, batchSize=<span class="hl-number">1</span>, throttle=<span class="hl-number">0.001</span>)</pre>
                <ul class="- topic/ul ul">
                    <li class="- topic/li li">
                        <p class="- topic/p p">使用 <code class="+ topic/ph pr-d/codeph ph codeph">createReactiveStateEngine</code> 函数定义一个响应式状态引擎：</p>
                        <ul class="- topic/ul ul">
                            <li class="- topic/li li">
                                <p class="- topic/p p">引擎需要一个在节点上唯一的名字，此处为 reactiveDemo</p>
                            </li>
                            <li class="- topic/li li">
                                <p class="- topic/p p">dummyTable=trade 表示引擎的输入表结构与表 <em class="+ topic/ph hi-d/i ph i">trade</em> 一致</p>
                            </li>
                            <li class="- topic/li li">
                                <p class="- topic/p p">outputTable=resultTable 表示计算结果输出到结果表 <em class="+ topic/ph hi-d/i ph i">resultTable</em></p>
                            </li>
                            <li class="- topic/li li">
                                <p class="- topic/p p">keyColumn="securityID" 表示按 securityID 分组计算，分组列会是引擎输出结果的第一列</p>
                            </li>
                            <li class="- topic/li li">
                                <p class="- topic/p p">metrics 定义了因子计算的逻辑，tradeTime 表示输出一列等于原始输入的 tradeTime
                                        列，<code class="+ topic/ph pr-d/codeph ph codeph">tmsum(tradeTime, iif(buyNo&gt;sellNo, tradeQty,
                                        0), 5m)\tmsum(tradeTime, tradeQty, 5m)</code>
                                    表示输出一列计算得到的主动成交量占比</p>
                            </li>
                        </ul>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p">定义 <code class="+ topic/ph pr-d/codeph ph codeph">factorCalFunc</code> 函数，函数内往引擎注入数据。</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p"><code class="+ topic/ph pr-d/codeph ph codeph">tmsum</code> 在响应式状态引擎中的含义与上文 SQL
                                语句中的业务含义一致，但是系统内部的实现会有不同，<code class="+ topic/ph pr-d/codeph ph codeph">tmsum</code>
                            在引擎内是基于上一条计算结果增量计算实现的，为此，引擎内会缓存必要的计算状态。以上文的输入为例，09:36:00.000 这条记录的过去 5
                            分钟的总成交量 = 上一条记录的过去5分钟总成交量 +09:36:00.000 当前这条记录的成交量-包含在上一条记录的过去 5
                            分钟窗口中但不包含在当前记录的过去5分钟窗口内的成交量。</p>
                    </li>
                </ul>
                <p class="- topic/p p">此外，<code class="+ topic/ph pr-d/codeph ph codeph">subscribeTable</code> 函数的 <em class="+ topic/ph hi-d/i ph i">handler</em>
                        参数也可以直接指定为数据表，而不一定必须是一元函数。<code class="+ topic/ph pr-d/codeph ph codeph">getStreamEngine("reactiveDemo")</code>
                    会返回流计算引擎的句柄，同样是一个数据表，所以可以直接将 <em class="+ topic/ph hi-d/i ph i">handler</em> 指定为引擎句柄，上述脚本可以简化为：</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python">createReactiveStateEngine(name=<span class="hl-string">"reactiveDemo"</span>, metrics=&lt;[tradeTime, tmsum(tradeTime, iif(buyNo&gt;sellNo, tradeQty, <span class="hl-number">0</span>), <span class="hl-number">5</span>m)\tmsum(tradeTime, tradeQty, <span class="hl-number">5</span>m)]&gt;, dummyTable=trade, outputTable=resultTable, keyColumn=<span class="hl-string">"securityID"</span>)

subscribeTable(tableName=<span class="hl-string">"trade"</span>, actionName=<span class="hl-string">"factorCal"</span>, offset=-<span class="hl-number">1</span>, handler=getStreamEngine(<span class="hl-string">"reactiveDemo"</span>), msgAsTable=true, batchSize=<span class="hl-number">1</span>, throttle=<span class="hl-number">0.001</span>)</pre>
            </div>
        </article>
        <article class="- topic/topic topic nested2" aria-labelledby="ariaid-title8" id="模拟数据输入">
            <h3 class="- topic/title title topictitle3" id="ariaid-title8">模拟数据输入</h3>
            <div class="- topic/body body">
                <p class="- topic/p p">那么，完整的流计算任务定义脚本如下：</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python">// 创建作为输入的流数据表
share(table=streamTable(<span class="hl-number">1</span>:<span class="hl-number">0</span>, `securityID`tradeTime`tradePrice`tradeQty`tradeAmount`buyNo`sellNo, [SYMBOL,TIMESTAMP,DOUBLE,INT,DOUBLE,LONG,LONG]), sharedName=`trade)
// 创建作为输出的流数据表
share(table=streamTable(<span class="hl-number">10000</span>:<span class="hl-number">0</span>, [<span class="hl-string">"securityID"</span>, <span class="hl-string">"tradeTime"</span>, <span class="hl-string">"factor"</span>], [SYMBOL, TIMESTAMP, DOUBLE]), sharedName=`resultTable)
// 定义处理函数
createReactiveStateEngine(name=<span class="hl-string">"reactiveDemo"</span>, metrics=&lt;[tradeTime, tmsum(tradeTime, iif(buyNo&gt;sellNo, tradeQty, <span class="hl-number">0</span>), <span class="hl-number">5</span>m)\tmsum(tradeTime, tradeQty, <span class="hl-number">5</span>m)]&gt;, dummyTable=trade, outputTable=resultTable, keyColumn=<span class="hl-string">"securityID"</span>)
// 订阅流数据表
subscribeTable(tableName=<span class="hl-string">"trade"</span>, actionName=<span class="hl-string">"factorCal"</span>, offset=-<span class="hl-number">1</span>, handler=getStreamEngine(<span class="hl-string">"reactiveDemo"</span>), msgAsTable=true, batchSize=<span class="hl-number">1</span>, throttle=<span class="hl-number">0.001</span>)</pre>
                <p class="- topic/p p">执行上述脚本后，我们提交了对流数据表 <em class="+ topic/ph hi-d/i ph i">trade</em>
                    的订阅，并指定使用响应式状态引擎来处理收到的订阅数据。接下来，我们往流数据表里注入一些数据来观察订阅消费的效果。</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python">insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">30</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.85</span>, <span class="hl-number">100</span>, <span class="hl-number">3085</span>, <span class="hl-number">4951</span>, <span class="hl-number">0</span>)
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">31</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.86</span>, <span class="hl-number">100</span>, <span class="hl-number">3086</span>, <span class="hl-number">4952</span>, <span class="hl-number">1</span>)
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">32</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.85</span>, <span class="hl-number">200</span>, <span class="hl-number">6170</span>, <span class="hl-number">5001</span>, <span class="hl-number">5100</span>)
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">33</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.83</span>, <span class="hl-number">100</span>, <span class="hl-number">3083</span>, <span class="hl-number">5202</span>, <span class="hl-number">5204</span>)
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">34</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.82</span>, <span class="hl-number">300</span>, <span class="hl-number">9246</span>, <span class="hl-number">5506</span>, <span class="hl-number">5300</span>)
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">35</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.82</span>, <span class="hl-number">500</span>, <span class="hl-number">15410</span>, <span class="hl-number">5510</span>, <span class="hl-number">5600</span>)</pre>
                <p class="- topic/p p">插入若干条数据到表 <em class="+ topic/ph hi-d/i ph i">trade</em> 后，查看结果表 <em class="+ topic/ph hi-d/i ph i">resultTable</em>：</p>
                <br/><img class="- topic/image image" src="images/try_example2_6.png"/><br/>
                <p class="- topic/p p">以上结果符合预期，我们再插入一条数据：</p>
                <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python">insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">36</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.87</span>, <span class="hl-number">800</span>, <span class="hl-number">24696</span>, <span class="hl-number">5700</span>, <span class="hl-number">5600</span>)</pre>
                <p class="- topic/p p">结果表对应地新增了一条记录，这一次，对于<code class="+ topic/ph pr-d/codeph ph codeph">09:36:00</code>这条记录我们得到了正确的 factor 值：</p>
                <br/><img class="- topic/image image" src="images/try_example2_7.png"/><br/>
                <p class="- topic/p p">至此，我们通过发布订阅框架以及流计算引擎完成了一个流计算任务的开发，不断地往流数据表 <em class="+ topic/ph hi-d/i ph i">trade</em>
                    中插入数据将会不断地触发计算并输出因子到结果表。</p>
            </div>
        </article>
    </article>
    <article class="- topic/topic topic nested1" aria-labelledby="ariaid-title9" id="进行运维">
        <h2 class="- topic/title title topictitle2" id="ariaid-title9">进行运维</h2>
        <article class="- topic/topic topic nested2" aria-labelledby="ariaid-title10" id="流计算运维">
            <h3 class="- topic/title title topictitle3" id="ariaid-title10">流计算运维</h3>
            <div class="- topic/body body">
                <p class="- topic/p p">消息处理线程为后台线程，流计算引擎里有内部状态，因此，系统提供了流计算运维函数来查看流计算的执行情况。除了使用函数查询外，在 2.00.11 及以上版本中也可以在
                    web 界面的流计算监控模块中直接查看。</p>
                <ul class="- topic/ul ul">
                    <li class="- topic/li li">
                        <p class="- topic/p p">查看流订阅消费的状态：</p>
                        <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python" id="流计算运维__codeblock_xzg_fdm_xzb" data-ofbid="流计算运维__codeblock_xzg_fdm_xzb">getStreamingStat().subWorkers</pre>
                        <p class="- topic/p p">执行以上代码后可以看到，节点上目前有一个订阅线程在工作，该订阅已经处理了 7 条消息，目前没有报错。订阅消费队列的最大深度为 1000
                            万，目前队列里没有待处理的数据。</p>
                        <br/><img class="- topic/image image" id="流计算运维__image_yzg_fdm_xzb" src="images/try_example2_8.png"/><br/>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p">查看流计算引擎的状态：</p>
                        <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python" id="流计算运维__codeblock_tlq_fdm_xzb" data-ofbid="流计算运维__codeblock_tlq_fdm_xzb">getStreamEngineStat().ReactiveStreamEngine</pre>
                        <p class="- topic/p p">执行以上代码后可以看到，目前插入引擎的输入数据中，只有一个分组（即 000155），共输入了 7 条数据，引擎内部维护的状态占用了 1836
                            字节。</p>
                        <br/><img class="- topic/image image" id="流计算运维__image_ulq_fdm_xzb" src="images/try_example2_9%E3%80%81.png"/><br/>
                    </li>
                </ul>
            </div>
        </article>
        <article class="- topic/topic topic nested2" aria-labelledby="ariaid-title11" id="流计算环境清理">
            <h3 class="- topic/title title topictitle3" id="ariaid-title11">流计算环境清理</h3>
            <div class="- topic/body body">
                <p class="- topic/p p">当流计算任务运行一段时间后，或许我们需要下线计算任务、更改计算逻辑或者修改输入源的表结构，那么我们可能需要将订阅、引擎或者流数据表分别取消掉，可以使用以下系统函数。</p>
                <ul class="- topic/ul ul">
                    <li class="- topic/li li">
                        <p class="- topic/p p">取消订阅：</p>
                        <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python" id="流计算环境清理__codeblock_trh_gdm_xzb" data-ofbid="流计算环境清理__codeblock_trh_gdm_xzb">unsubscribeTable(tableName=<span class="hl-string">"trade"</span>, actionName=<span class="hl-string">"factorCal"</span>)</pre>
                        <p class="- topic/p p">执行以上代码可以取消特定的订阅关系，之后表 <em class="+ topic/ph hi-d/i ph i">trade</em> 再发布数据，系统也不会计算主动成交量因子。</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p">释放流计算引擎：</p>
                        <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python" id="流计算环境清理__codeblock_umr_gdm_xzb" data-ofbid="流计算环境清理__codeblock_umr_gdm_xzb">dropStreamEngine(`reactiveDemo)</pre>
                        <p class="- topic/p p">执行以上脚本可以释放流计算引擎 <code class="+ topic/ph pr-d/codeph ph codeph">reactiveDemo</code> ，引擎占用的内存也会一起释放。</p>
                    </li>
                    <li class="- topic/li li">
                        <p class="- topic/p p">删除流数据表：</p>
                        <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python" id="流计算环境清理__codeblock_dt2_hdm_xzb" data-ofbid="流计算环境清理__codeblock_dt2_hdm_xzb">dropStreamTable(`trade)</pre>
                    </li>
                </ul>
            </div>
        </article>
    </article>
    <article class="- topic/topic topic nested1" aria-labelledby="ariaid-title12" id="附录">
        <h2 class="- topic/title title topictitle2" id="ariaid-title12">附录</h2>
        <div class="- topic/body body">
            <p class="- topic/p p">
                <strong class="+ topic/ph hi-d/b ph b">完整脚本</strong>
            </p>
            <pre class="+ topic/pre pr-d/codeblock pre codeblock language-python">// 创建作为输入的流数据表
share(table=streamTable(<span class="hl-number">1</span>:<span class="hl-number">0</span>, `securityID`tradeTime`tradePrice`tradeQty`tradeAmount`buyNo`sellNo, [SYMBOL,TIMESTAMP,DOUBLE,INT,DOUBLE,LONG,LONG]), sharedName=`trade)
// 创建作为输出的流数据表
share(table=streamTable(<span class="hl-number">10000</span>:<span class="hl-number">0</span>, [<span class="hl-string">"securityID"</span>, <span class="hl-string">"tradeTime"</span>, <span class="hl-string">"factor"</span>], [SYMBOL, TIMESTAMP, DOUBLE]), sharedName=`resultTable)
go
// 定义处理函数
createReactiveStateEngine(name=<span class="hl-string">"reactiveDemo"</span>, metrics=&lt;[tradeTime, tmsum(tradeTime, iif(buyNo&gt;sellNo, tradeQty, <span class="hl-number">0</span>), <span class="hl-number">5</span>m)\tmsum(tradeTime, tradeQty, <span class="hl-number">5</span>m)]&gt;, dummyTable=trade, outputTable=resultTable, keyColumn=<span class="hl-string">"securityID"</span>)
// 订阅流数据表
subscribeTable(tableName=<span class="hl-string">"trade"</span>, actionName=<span class="hl-string">"factorCal"</span>, offset=-<span class="hl-number">1</span>, handler=getStreamEngine(<span class="hl-string">"reactiveDemo"</span>), msgAsTable=true, batchSize=<span class="hl-number">1</span>, throttle=<span class="hl-number">0.001</span>)
go
// 模拟数据输入
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">30</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.85</span>, <span class="hl-number">100</span>, <span class="hl-number">3085</span>, <span class="hl-number">4951</span>, <span class="hl-number">0</span>)
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">31</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.86</span>, <span class="hl-number">100</span>, <span class="hl-number">3086</span>, <span class="hl-number">4952</span>, <span class="hl-number">1</span>)
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">32</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.85</span>, <span class="hl-number">200</span>, <span class="hl-number">6170</span>, <span class="hl-number">5001</span>, <span class="hl-number">5100</span>)
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">33</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.83</span>, <span class="hl-number">100</span>, <span class="hl-number">3083</span>, <span class="hl-number">5202</span>, <span class="hl-number">5204</span>)
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">34</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.82</span>, <span class="hl-number">300</span>, <span class="hl-number">9246</span>, <span class="hl-number">5506</span>, <span class="hl-number">5300</span>)
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">35</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.82</span>, <span class="hl-number">500</span>, <span class="hl-number">15410</span>, <span class="hl-number">5510</span>, <span class="hl-number">5600</span>)
insert into trade values(`<span class="hl-number">000155</span>, <span class="hl-number">2020.01</span>.<span class="hl-number">01</span>T09:<span class="hl-number">36</span>:<span class="hl-number">00.000</span>, <span class="hl-number">30.87</span>, <span class="hl-number">800</span>, <span class="hl-number">24696</span>, <span class="hl-number">5700</span>, <span class="hl-number">5600</span>)</pre>
        </div>
    </article>
</article></main></div>
                        
                        
                        
                        
                        
                        
                    </div>
                    
                        <nav role="navigation" id="wh_topic_toc" aria-label="On this page" class="col-lg-2 d-none d-lg-block navbar d-print-none"> 
                            <div id="wh_topic_toc_content">
		                        
	                            <div class=" wh_topic_toc "><div class="wh_topic_label">在本页上</div><ul><li class="topic-item"><a href="#%E6%88%91%E4%BB%AC%E8%A6%81%E8%AE%A1%E7%AE%97%E4%BB%80%E4%B9%88" data-tocid="我们要计算什么">计算目标</a></li><li class="topic-item"><a href="#%E5%8A%A8%E6%89%8B%E5%AE%9E%E7%8E%B0" data-tocid="动手实现">动手实现</a><ul><li class="topic-item"><a href="#%E5%88%9B%E5%BB%BA%E4%BD%9C%E4%B8%BA%E8%BE%93%E5%85%A5%E7%9A%84%E6%B5%81%E6%95%B0%E6%8D%AE%E8%A1%A8" data-tocid="创建作为输入的流数据表">创建作为输入的流数据表</a></li><li class="topic-item"><a href="#%E5%88%9B%E5%BB%BA%E4%BD%9C%E4%B8%BA%E8%BE%93%E5%87%BA%E7%9A%84%E6%B5%81%E6%95%B0%E6%8D%AE%E8%A1%A8" data-tocid="创建作为输出的流数据表">创建作为输出的流数据表</a></li><li class="topic-item"><a href="#%E8%AE%A2%E9%98%85%E6%B5%81%E6%95%B0%E6%8D%AE%E8%A1%A8" data-tocid="订阅流数据表">订阅流数据表</a></li><li class="topic-item"><a href="#%E4%BD%BF%E7%94%A8%E6%B5%81%E8%AE%A1%E7%AE%97%E5%BC%95%E6%93%8E%E5%AE%9A%E4%B9%89%E8%AE%A1%E7%AE%97%E9%80%BB%E8%BE%91" data-tocid="使用流计算引擎定义计算逻辑">使用流计算引擎定义计算逻辑</a></li><li class="topic-item"><a href="#%E6%A8%A1%E6%8B%9F%E6%95%B0%E6%8D%AE%E8%BE%93%E5%85%A5" data-tocid="模拟数据输入">模拟数据输入</a></li></ul></li><li class="topic-item"><a href="#%E8%BF%9B%E8%A1%8C%E8%BF%90%E7%BB%B4" data-tocid="进行运维">进行运维</a><ul><li class="topic-item"><a href="#%E6%B5%81%E8%AE%A1%E7%AE%97%E8%BF%90%E7%BB%B4" data-tocid="流计算运维">流计算运维</a></li><li class="topic-item"><a href="#%E6%B5%81%E8%AE%A1%E7%AE%97%E7%8E%AF%E5%A2%83%E6%B8%85%E7%90%86" data-tocid="流计算环境清理">流计算环境清理</a></li></ul></li><li class="topic-item"><a href="#%E9%99%84%E5%BD%95" data-tocid="附录">附录</a></li></ul></div>
	                        	
                        	</div>
                        </nav>
                    
                </div>
            </div>
            
            
            
        </div> 
        <footer class="navbar navbar-default wh_footer">
  <div class=" footer-container mx-auto ">
<title>Copyright</title><p><b> ©2024 浙江智臾科技有限公司 浙ICP备18048711号-3</b></p>
  </div>
</footer>
        
        <div id="go2top" class="d-print-none">
            <span class="oxy-icon oxy-icon-up"></span>
        </div>
        
        <div id="modal_img_large" class="modal">
            <span class="close oxy-icon oxy-icon-remove"></span>
            <div id="modal_img_container"></div>
            <div id="caption"></div>
        </div>
        
        
        
    </body>
</html>