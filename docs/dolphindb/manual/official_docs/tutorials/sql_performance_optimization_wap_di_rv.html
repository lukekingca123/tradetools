<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh" lang="zh" data-whc_version="26.0">
    <head><link rel="shortcut icon" href="../favicon.ico"/><link rel="icon" href="../favicon.ico"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="description" content="在金融行业的数据分析工作中，数据预处理及特征工程的质量往往决定了数学模型的实际效果。某些金融指标涉及原始大量数据中高维多列的复杂运算，这将耗费大量的计算资源和开发时间。本案例基于证券交易的 level2 快照数据，开发了 10 分钟频率的深度不平衡、买卖压力指标和波动率的计算脚本，旨在为 DolphinDB 使用者在开发其他类似因子计算脚本时提供参考范例，提高开发效率。 优化前后计算效率 ..."/><meta name="DC.rights.owner" content="(C) 版权 2024"/><meta name="copyright" content="(C) 版权 2024"/><meta name="generator" content="DITA-OT"/><meta name="DC.type" content="topic"/><meta name="DC.coverage" content=""/><meta name="DC.relation" content="../tutorials/about_tutorials.html"/><meta name="prodname" content="DolphinDB"/><meta name="brand" content="DolphinDB"/><meta name="DC.creator" content="DolphinDB"/><meta name="DC.publisher" content="DDB N/A DDB 200"/><meta name="DC.format" content="HTML5"/><meta name="DC.identifier" content="深度不平衡买卖压力指标波动率计算"/><title>深度不平衡、买卖压力指标、波动率计算</title><!--  Generated with Oxygen version 26.0, build number 2024012323.  --><meta name="wh-path2root" content="../"/><meta name="wh-toc-id" content="&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;&lt;?workdir /tmp/temp20240704100525325/tutorials?&gt;&lt;?workdir-uri file:/tmp/temp20240704100525325/tutorials/?&gt;&lt;?path2project ../?&gt;&lt;?path2project-uri ../?&gt;&lt;?path2rootmap-uri ../?&gt;&lt;topic xmlns:dita-ot=&#34;http://dita-ot.sourceforge.net/ns/201007/dita-ot&#34; xmlns:ditaarch=&#34;http://dita.oasis-open.org/architecture/2005/&#34; class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;深度不平衡买卖压力指标波动率计算&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:1;1:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:1;1:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;深度不平衡、买卖压力指标、波动率计算&lt;/title&gt;&lt;prolog class=&#34;- topic/prolog &#34;&gt;&lt;author class=&#34;- topic/author &#34; xtrc=&#34;author:1;12:17&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt;DolphinDB&lt;/author&gt;&lt;publisherinformation class=&#34;- topic/publisher bookmap/publisherinformation &#34; xtrc=&#34;publisherinformation:1;14:31&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt; &lt;person class=&#34;- topic/data bookmap/person &#34; xtrc=&#34;person:1;15:21&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt;DDB&lt;/person&gt; &lt;printlocation class=&#34;- topic/data bookmap/printlocation &#34; xtrc=&#34;printlocation:1;16:28&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt;N/A&lt;/printlocation&gt; &lt;published class=&#34;- topic/data bookmap/published &#34; xtrc=&#34;published:1;17:24&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt; &lt;person class=&#34;- topic/data bookmap/person &#34; xtrc=&#34;person:2;18:25&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt;DDB&lt;/person&gt; &lt;publishtype class=&#34;- topic/data bookmap/publishtype &#34; value=&#34;HTML&#34; xtrc=&#34;publishtype:1;19:44&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;/&gt; &lt;revisionid class=&#34;- topic/ph bookmap/revisionid &#34; xtrc=&#34;revisionid:1;20:29&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt;200&lt;/revisionid&gt; &lt;summary class=&#34;- topic/ph bookmap/summary &#34; xtrc=&#34;summary:1;22:27&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;/&gt; &lt;data class=&#34;- topic/data &#34; xtrc=&#34;data:1;23:24&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;/&gt; &lt;/published&gt; &lt;data class=&#34;- topic/data &#34; xtrc=&#34;data:2;25:20&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;/&gt; &lt;/publisherinformation&gt;&lt;metadata class=&#34;- topic/metadata &#34;&gt;&lt;audience class=&#34;- topic/audience &#34; xtrc=&#34;audience:2;39:20&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;/&gt;&lt;audience class=&#34;- topic/audience &#34; xtrc=&#34;audience:1;28:24&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;/&gt;&lt;category class=&#34;- topic/category &#34; xtrc=&#34;category:1;29:24&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;/&gt;&lt;prodinfo class=&#34;- topic/prodinfo &#34; xtrc=&#34;prodinfo:1;34:23&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt; &lt;prodname class=&#34;- topic/prodname &#34; xtrc=&#34;prodname:1;35:27&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt;DolphinDB&lt;/prodname&gt; &lt;brand class=&#34;- topic/brand &#34; xtrc=&#34;brand:1;36:24&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/ddb_doc_centre.ditamap&#34;&gt;DolphinDB&lt;/brand&gt; &lt;/prodinfo&gt;&lt;/metadata&gt;&lt;/prolog&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:1;1:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:1;3:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;在金融行业的数据分析工作中，数据预处理及特征工程的质量往往决定了数学模型的实际效果。某些金融指标涉及原始大量数据中高维多列的复杂运算，这将耗费大量的计算资源和开发时间。本案例基于证券交易的 level2 快照数据，开发了 10 分钟频率的深度不平衡、买卖压力指标和波动率的计算脚本，旨在为 DolphinDB 使用者在开发其他类似因子计算脚本时提供参考范例，提高开发效率。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:2;5:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;b class=&#34;+ topic/ph hi-d/b &#34; xtrc=&#34;b:1;5:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;优化前后计算效率&lt;/b&gt;&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:1;7:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:1;7:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;分布式表数据总量：2,874,861,174&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:2;8:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;上证 50 指数的成分股数据量：58,257,708&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:3;9:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;处理后的结果表数据量：267,490&lt;/li&gt;&lt;/ul&gt;&lt;table class=&#34;- topic/table &#34; xtrc=&#34;table:1;11:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;tgroup class=&#34;- topic/tgroup &#34; cols=&#34;5&#34; xtrc=&#34;tgroup:1;11:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;colspec class=&#34;- topic/colspec &#34; colname=&#34;col1&#34; colnum=&#34;1&#34; xtrc=&#34;colspec:1;11:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;/&gt;&lt;colspec class=&#34;- topic/colspec &#34; colname=&#34;col2&#34; colnum=&#34;2&#34; xtrc=&#34;colspec:2;11:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;/&gt;&lt;colspec class=&#34;- topic/colspec &#34; colname=&#34;col3&#34; colnum=&#34;3&#34; xtrc=&#34;colspec:3;11:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;/&gt;&lt;colspec class=&#34;- topic/colspec &#34; colname=&#34;col4&#34; colnum=&#34;4&#34; xtrc=&#34;colspec:4;11:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;/&gt;&lt;colspec class=&#34;- topic/colspec &#34; colname=&#34;col5&#34; colnum=&#34;5&#34; xtrc=&#34;colspec:5;11:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;/&gt;&lt;thead class=&#34;- topic/thead &#34; xtrc=&#34;thead:1;11:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:1;11:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;1&#34; xtrc=&#34;entry:1;11:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;存储引擎&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;1&#34; xtrc=&#34;entry:2;11:9&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;十档买卖量价存储方式&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;1&#34; xtrc=&#34;entry:3;11:22&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;计算对象&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;1&#34; xtrc=&#34;entry:4;11:29&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;逻辑 CPU 核数&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col5&#34; dita-ot:x=&#34;5&#34; dita-ot:y=&#34;1&#34; xtrc=&#34;entry:5;11:41&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;计算耗时（s）&lt;/entry&gt;&lt;/row&gt;&lt;/thead&gt;&lt;tbody class=&#34;- topic/tbody &#34; xtrc=&#34;tbody:1;13:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:2;13:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;2&#34; xtrc=&#34;entry:6;13:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OLAP&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;2&#34; xtrc=&#34;entry:7;13:13&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;40 列&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;2&#34; xtrc=&#34;entry:8;13:36&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;列为单位&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;2&#34; xtrc=&#34;entry:9;13:43&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;8&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col5&#34; dita-ot:x=&#34;5&#34; dita-ot:y=&#34;2&#34; xtrc=&#34;entry:10;13:57&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;450&lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:3;14:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;3&#34; xtrc=&#34;entry:11;14:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OLAP&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;3&#34; xtrc=&#34;entry:12;14:13&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;40 列&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;3&#34; xtrc=&#34;entry:13;14:36&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;矩阵&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;3&#34; xtrc=&#34;entry:14;14:45&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;8&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col5&#34; dita-ot:x=&#34;5&#34; dita-ot:y=&#34;3&#34; xtrc=&#34;entry:15;14:59&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;450&lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:4;15:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;4&#34; xtrc=&#34;entry:16;15:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;TSDB&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;4&#34; xtrc=&#34;entry:17;15:13&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;40 列&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;4&#34; xtrc=&#34;entry:18;15:36&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;矩阵&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;4&#34; xtrc=&#34;entry:19;15:45&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;8&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col5&#34; dita-ot:x=&#34;5&#34; dita-ot:y=&#34;4&#34; xtrc=&#34;entry:20;15:59&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;27&lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:5;16:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;5&#34; xtrc=&#34;entry:21;16:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;TSDB&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;5&#34; xtrc=&#34;entry:22;16:13&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;4 列（array vector）&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;5&#34; xtrc=&#34;entry:23;16:34&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;矩阵&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;5&#34; xtrc=&#34;entry:24;16:43&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;8&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col5&#34; dita-ot:x=&#34;5&#34; dita-ot:y=&#34;5&#34; xtrc=&#34;entry:25;16:57&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;25&lt;/entry&gt;&lt;/row&gt;&lt;/tbody&gt;&lt;/tgroup&gt;&lt;/table&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:3;18:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;本教程包含内容：&lt;/p&gt;&lt;/body&gt;&lt;related-links class=&#34;- topic/related-links &#34;&gt;&lt;linkpool class=&#34;- topic/linkpool &#34; xtrc=&#34;topicref:102;133:101&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/chap_tutorials.ditamap&#34;&gt;&lt;link class=&#34;- topic/link &#34; format=&#34;dita&#34; href=&#34;../tutorials/about_tutorials.dita&#34; mapclass=&#34;- map/topicref bookmap/chapter &#34; role=&#34;parent&#34; scope=&#34;local&#34; type=&#34;topic&#34; xtrc=&#34;topicref:1;5:53&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/chap_tutorials.ditamap&#34;&gt;&lt;?ditaot usertext?&gt;&lt;linktext class=&#34;- topic/linktext &#34;&gt;&lt;?ditaot usertext?&gt;教程&lt;/linktext&gt;&lt;?ditaot usershortdesc?&gt;&lt;desc class=&#34;- topic/desc &#34;&gt;DolphinDB 产品使用教程&lt;/desc&gt;&lt;/link&gt;&lt;/linkpool&gt;&lt;/related-links&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;1-snapshot-数据文件结构&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:2;20:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:2;20:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;1. Snapshot 数据文件结构&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:2;20:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;table class=&#34;- topic/table &#34; xtrc=&#34;table:2;22:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;tgroup class=&#34;- topic/tgroup &#34; cols=&#34;6&#34; xtrc=&#34;tgroup:2;22:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;colspec class=&#34;- topic/colspec &#34; colname=&#34;col1&#34; colnum=&#34;1&#34; xtrc=&#34;colspec:6;22:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;/&gt;&lt;colspec class=&#34;- topic/colspec &#34; colname=&#34;col2&#34; colnum=&#34;2&#34; xtrc=&#34;colspec:7;22:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;/&gt;&lt;colspec class=&#34;- topic/colspec &#34; colname=&#34;col3&#34; colnum=&#34;3&#34; xtrc=&#34;colspec:8;22:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;/&gt;&lt;colspec class=&#34;- topic/colspec &#34; colname=&#34;col4&#34; colnum=&#34;4&#34; xtrc=&#34;colspec:9;22:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;/&gt;&lt;colspec class=&#34;- topic/colspec &#34; colname=&#34;col5&#34; colnum=&#34;5&#34; xtrc=&#34;colspec:10;22:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;/&gt;&lt;colspec class=&#34;- topic/colspec &#34; colname=&#34;col6&#34; colnum=&#34;6&#34; xtrc=&#34;colspec:11;22:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;/&gt;&lt;thead class=&#34;- topic/thead &#34; xtrc=&#34;thead:2;22:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:6;22:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;1&#34; xtrc=&#34;entry:26;22:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;字段&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;1&#34; xtrc=&#34;entry:27;22:15&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;含义&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;1&#34; xtrc=&#34;entry:28;22:22&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;字段&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;1&#34; xtrc=&#34;entry:29;22:41&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;含义&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col5&#34; dita-ot:x=&#34;5&#34; dita-ot:y=&#34;1&#34; xtrc=&#34;entry:30;22:49&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;字段&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col6&#34; dita-ot:x=&#34;6&#34; dita-ot:y=&#34;1&#34; xtrc=&#34;entry:31;22:69&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;含义&lt;/entry&gt;&lt;/row&gt;&lt;/thead&gt;&lt;tbody class=&#34;- topic/tbody &#34; xtrc=&#34;tbody:2;24:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:7;24:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;2&#34; xtrc=&#34;entry:32;24:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;SecurityID&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;2&#34; xtrc=&#34;entry:33;24:15&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;证券代码&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;2&#34; xtrc=&#34;entry:34;24:22&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;LowPx&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;2&#34; xtrc=&#34;entry:35;24:41&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;最低价&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col5&#34; dita-ot:x=&#34;5&#34; dita-ot:y=&#34;2&#34; xtrc=&#34;entry:36;24:49&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;BidPrice[10]&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col6&#34; dita-ot:x=&#34;6&#34; dita-ot:y=&#34;2&#34; xtrc=&#34;entry:37;24:70&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;申买十价&lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:8;25:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;3&#34; xtrc=&#34;entry:38;25:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;DateTime&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;3&#34; xtrc=&#34;entry:39;25:15&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;日期时间&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;3&#34; xtrc=&#34;entry:40;25:22&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;LastPx&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;3&#34; xtrc=&#34;entry:41;25:41&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;最新价&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col5&#34; dita-ot:x=&#34;5&#34; dita-ot:y=&#34;3&#34; xtrc=&#34;entry:42;25:49&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;BidOrderQty[10]&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col6&#34; dita-ot:x=&#34;6&#34; dita-ot:y=&#34;3&#34; xtrc=&#34;entry:43;25:70&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;申买十量&lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:9;26:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;4&#34; xtrc=&#34;entry:44;26:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;PreClosePx&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;4&#34; xtrc=&#34;entry:45;26:15&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;昨收价&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;4&#34; xtrc=&#34;entry:46;26:22&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;TotalVolumeTrade&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;4&#34; xtrc=&#34;entry:47;26:41&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;成交总量&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col5&#34; dita-ot:x=&#34;5&#34; dita-ot:y=&#34;4&#34; xtrc=&#34;entry:48;26:49&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OfferPrice[10]&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col6&#34; dita-ot:x=&#34;6&#34; dita-ot:y=&#34;4&#34; xtrc=&#34;entry:49;26:70&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;申卖十价&lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:10;27:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;5&#34; xtrc=&#34;entry:50;27:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OpenPx&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;5&#34; xtrc=&#34;entry:51;27:15&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;开始价&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;5&#34; xtrc=&#34;entry:52;27:22&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;TotalValueTrade&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;5&#34; xtrc=&#34;entry:53;27:41&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;成交总金额&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col5&#34; dita-ot:x=&#34;5&#34; dita-ot:y=&#34;5&#34; xtrc=&#34;entry:54;27:49&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OfferOrderQty[10]&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col6&#34; dita-ot:x=&#34;6&#34; dita-ot:y=&#34;5&#34; xtrc=&#34;entry:55;27:70&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;申卖十量&lt;/entry&gt;&lt;/row&gt;&lt;row class=&#34;- topic/row &#34; xtrc=&#34;row:11;28:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col1&#34; dita-ot:x=&#34;1&#34; dita-ot:y=&#34;6&#34; xtrc=&#34;entry:56;28:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;HighPx&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col2&#34; dita-ot:x=&#34;2&#34; dita-ot:y=&#34;6&#34; xtrc=&#34;entry:57;28:15&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;最高价&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col3&#34; dita-ot:x=&#34;3&#34; dita-ot:y=&#34;6&#34; xtrc=&#34;entry:58;28:22&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;InstrumentStatus&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col4&#34; dita-ot:x=&#34;4&#34; dita-ot:y=&#34;6&#34; xtrc=&#34;entry:59;28:41&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;交易状态&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col5&#34; dita-ot:x=&#34;5&#34; dita-ot:y=&#34;6&#34; xtrc=&#34;entry:60;28:49&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;……&lt;/entry&gt;&lt;entry class=&#34;- topic/entry &#34; colname=&#34;col6&#34; dita-ot:x=&#34;6&#34; dita-ot:y=&#34;6&#34; xtrc=&#34;entry:61;28:69&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;……&lt;/entry&gt;&lt;/row&gt;&lt;/tbody&gt;&lt;/tgroup&gt;&lt;/table&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:4;30:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;本案例用到的字段为 Snapshot 中的部分字段，包括：股票代码、快照时间、申买十价，申买十量，申卖十价，申卖十量。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:5;32:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;样本为 2020 年上证 50 指数的成分股：&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:2;34:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:4;34:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:6;34:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;股票代码&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; outputclass=&#34;tex&#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:1;36:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;601318,600519,600036,600276,601166,600030,600887,600016,601328,601288, 600000,600585,601398,600031,601668,600048,601888,600837,601601,601012, 603259,601688,600309,601988,601211,600009,600104,600690,601818,600703, 600028,601088,600050,601628,601857,601186,600547,601989,601336,600196, 603993,601138,601066,601236,601319,603160,600588,601816,601658,600745&lt;/codeblock&gt;&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:5;44:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:7;44:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;股票名称&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; outputclass=&#34;tex&#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:2;46:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;中国平安、贵州茅台、招商银行、恒瑞医药、兴业银行、中信证券、伊利股份、民生银行、交通银行、农业银行、 浦发银行、海螺水泥、工商银行、三一重工、中国建筑、保利地产、中国中免、海通证券、中国太保、隆基股份、 药明康德、华泰证券、万华化学、中国银行、国泰君安、上海机场、上汽集团、海尔智家、光大银行、三安光电、 中国石化、中国神华、中国联通、中国人寿、中国石油、中国铁建、山东黄金、中国重工、新华保险、复星医药、 洛阳钼业、工业富联、中信建投、红塔证券、中国人保、汇顶科技、用友网络、京沪高铁、邮储银行、闻泰科技&lt;/codeblock&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:8;54:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;2020 年上交所 14460 个证券的 Snapshot 数据已经提前导入至 DolphinDB 数据库中，一共约 28.75 亿条快照数据，导入方法见&lt;xref class=&#34;- topic/xref &#34; dita-ot:orig-format=&#34;md&#34; format=&#34;dita&#34; href=&#34;stockdata_csv_import_demo.md&#34; xtrc=&#34;xref:1;54:78&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34; type=&#34;topic&#34;&gt;&lt;?ditaot usertext?&gt;股票行情数据导入实例&lt;/xref&gt;，一共 174 列。&lt;/p&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;2-指标定义&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:3;56:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:3;56:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;2. 指标定义&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:3;56:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:3;58:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:6;58:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:9;58:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;b class=&#34;+ topic/ph hi-d/b &#34; xtrc=&#34;b:2;58:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;Weighted Averaged Price(WAP)&lt;/b&gt;：加权平均价格&lt;/p&gt;&lt;image class=&#34;- topic/image &#34; href=&#34;images/sql_performance_optimization_wap_di_rv/wap.png&#34; xtrc=&#34;image:1;60:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34; dita-ot:image-width=&#34;570&#34; dita-ot:image-height=&#34;63&#34; dita-ot:horizontal-dpi=&#34;96&#34; dita-ot:vertical-dpi=&#34;96&#34;/&gt;&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:7;62:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:10;62:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;b class=&#34;+ topic/ph hi-d/b &#34; xtrc=&#34;b:3;62:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;Depth Imbalance(DI)&lt;/b&gt;：深度不平衡&lt;/p&gt;&lt;image class=&#34;- topic/image &#34; href=&#34;images/sql_performance_optimization_wap_di_rv/dij.png&#34; xtrc=&#34;image:2;64:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34; dita-ot:image-width=&#34;406&#34; dita-ot:image-height=&#34;64&#34; dita-ot:horizontal-dpi=&#34;96&#34; dita-ot:vertical-dpi=&#34;96&#34;/&gt;&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:8;66:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:11;66:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;b class=&#34;+ topic/ph hi-d/b &#34; xtrc=&#34;b:4;66:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;Press&lt;/b&gt;：买卖压力指标&lt;/p&gt;&lt;image class=&#34;- topic/image &#34; href=&#34;images/sql_performance_optimization_wap_di_rv/wi.png&#34; xtrc=&#34;image:3;68:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34; dita-ot:image-width=&#34;332&#34; dita-ot:image-height=&#34;279&#34; dita-ot:horizontal-dpi=&#34;96&#34; dita-ot:vertical-dpi=&#34;96&#34;/&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:12;70:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;b class=&#34;+ topic/ph hi-d/b &#34; xtrc=&#34;b:5;70:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;特征数据重采样（10min 窗口，并聚合计算波动率）&lt;/b&gt;&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:13;72:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;重采样利用&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:1;72:6&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;group by SecurityID, interval( TradeTime, 10m, &#34;none&#34; )&lt;/codeph&gt;方法&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:4;74:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:9;74:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:14;74:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;b class=&#34;+ topic/ph hi-d/b &#34; xtrc=&#34;b:6;74:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;Realized Volatility(RV)&lt;/b&gt;：波动率定义为对数收益率的平方和的平方根&lt;/p&gt;&lt;image class=&#34;- topic/image &#34; href=&#34;images/sql_performance_optimization_wap_di_rv/rv.png&#34; xtrc=&#34;image:4;76:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34; dita-ot:image-width=&#34;90&#34; dita-ot:image-height=&#34;39&#34; dita-ot:horizontal-dpi=&#34;96&#34; dita-ot:vertical-dpi=&#34;96&#34;/&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:15;78:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;股票的价格始终是处于买单价和卖单价之间，因此本项目用加权平均价格来代替股价进行计算&lt;/p&gt;&lt;image class=&#34;- topic/image &#34; href=&#34;images/sql_performance_optimization_wap_di_rv/rt1t2.png&#34; xtrc=&#34;image:5;80:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34; dita-ot:image-width=&#34;156&#34; dita-ot:image-height=&#34;130&#34; dita-ot:horizontal-dpi=&#34;96&#34; dita-ot:vertical-dpi=&#34;96&#34;/&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;3-sql-优化&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:4;82:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:4;82:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;3. SQL 优化&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:4;82:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:16;84:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;这些指标的计算 SQL 语句由以下几部分组成：&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:3;86:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;SELECT 指标计算函数(参数) FROM 数据源 WHERE 日期筛选条件,股票筛选条件,交易时间筛选条件 GROUP BY 股票代码, interval(时间列,时间单位,缺失值填充方式)&lt;/codeblock&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:17;93:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;本教程的优化部分为指标计算函数的处理过程。&lt;/p&gt;&lt;/body&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;31-新手以列为单位进行计算&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:5;95:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:5;95:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;3.1. 新手：以列为单位进行计算&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:5;95:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:18;97:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;数据采用 OLAP 存储引擎存储。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:19;99:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;根据指标定义公式，以列为单位进行计算，开发者能够快速写出以下 SQL 代码：&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:4;101:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;/** part1: Define calculation function */ def calPress(BidPrice0,BidPrice1,BidPrice2,BidPrice3,BidPrice4,BidPrice5,BidPrice6,BidPrice7,BidPrice8,BidPrice9,BidOrderQty0,BidOrderQty1,BidOrderQty2,BidOrderQty3,BidOrderQty4,BidOrderQty5,BidOrderQty6,BidOrderQty7,BidOrderQty8,BidOrderQty9,OfferPrice0,OfferPrice1,OfferPrice2,OfferPrice3,OfferPrice4,OfferPrice5,OfferPrice6,OfferPrice7,OfferPrice8,OfferPrice9,OfferOrderQty0,OfferOrderQty1,OfferOrderQty2,OfferOrderQty3,OfferOrderQty4,OfferOrderQty5,OfferOrderQty6,OfferOrderQty7,OfferOrderQty8,OfferOrderQty9){ WAP = (BidPrice0*OfferOrderQty0+OfferPrice0*BidOrderQty0)\(BidOrderQty0+OfferOrderQty0) Bid_1_P_WAP_SUM = 1\(BidPrice0-WAP) + 1\(BidPrice1-WAP) + 1\(BidPrice2-WAP) + 1\(BidPrice3-WAP) + 1\(BidPrice4-WAP) + 1\(BidPrice5-WAP) + 1\(BidPrice6-WAP) + 1\(BidPrice7-WAP) + 1\(BidPrice8-WAP) + 1\(BidPrice9-WAP) Offer_1_P_WAP_SUM = 1\(OfferPrice0-WAP)+1\(OfferPrice1-WAP)+1\(OfferPrice2-WAP)+1\(OfferPrice3-WAP)+1\(OfferPrice4-WAP)+1\(OfferPrice5-WAP)+1\(OfferPrice6-WAP)+1\(OfferPrice7-WAP)+1\(OfferPrice8-WAP)+1\(OfferPrice9-WAP) BidPress = BidOrderQty0*((1\(BidPrice0-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty1*((1\(BidPrice1-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty2*((1\(BidPrice2-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty3*((1\(BidPrice3-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty4*((1\(BidPrice4-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty5*((1\(BidPrice5-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty6*((1\(BidPrice6-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty7*((1\(BidPrice7-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty8*((1\(BidPrice8-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty9*((1\(BidPrice9-WAP))\Bid_1_P_WAP_SUM) OfferPress = OfferOrderQty0*((1\(OfferPrice0-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty1*((1\(OfferPrice1-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty2*((1\(OfferPrice2-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty3*((1\(OfferPrice3-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty4*((1\(OfferPrice4-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty5*((1\(OfferPrice5-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty6*((1\(OfferPrice6-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty7*((1\(OfferPrice7-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty8*((1\(OfferPrice8-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty9*((1\(OfferPrice9-WAP))\Offer_1_P_WAP_SUM) return log(BidPress)-log(OfferPress) } /** part2: Define variables and assign values */ stockList=`601318`600519`600036`600276`601166`600030`600887`600016`601328`601288`600000`600585`601398`600031`601668`600048`601888`600837`601601`601012`603259`601688`600309`601988`601211`600009`600104`600690`601818`600703`600028`601088`600050`601628`601857`601186`600547`601989`601336`600196`603993`601138`601066`601236`601319`603160`600588`601816`601658`600745 dbName = &#34;dfs://snapshot_SH_L2_OLAP&#34; tableName = &#34;snapshot_SH_L2_OLAP&#34; snapshot = loadTable(dbName, tableName) /** part3: Execute SQL */ result = select avg((OfferPrice0\BidPrice0-1)) as BAS, avg((BidOrderQty0-OfferOrderQty0)\(BidOrderQty0+OfferOrderQty0)) as DI0, avg((BidOrderQty1-OfferOrderQty1)\(BidOrderQty1+OfferOrderQty1)) as DI1, avg((BidOrderQty2-OfferOrderQty2)\(BidOrderQty2+OfferOrderQty2)) as DI2, avg((BidOrderQty3-OfferOrderQty3)\(BidOrderQty3+OfferOrderQty3)) as DI3, avg((BidOrderQty4-OfferOrderQty4)\(BidOrderQty4+OfferOrderQty4)) as DI4, avg((BidOrderQty5-OfferOrderQty5)\(BidOrderQty5+OfferOrderQty5)) as DI5, avg((BidOrderQty6-OfferOrderQty6)\(BidOrderQty6+OfferOrderQty6)) as DI6, avg((BidOrderQty7-OfferOrderQty7)\(BidOrderQty7+OfferOrderQty7)) as DI7, avg((BidOrderQty8-OfferOrderQty8)\(BidOrderQty8+OfferOrderQty8)) as DI8, avg((BidOrderQty9-OfferOrderQty9)\(BidOrderQty9+OfferOrderQty9)) as DI9, avg(calPress(BidPrice0,BidPrice1,BidPrice2,BidPrice3,BidPrice4,BidPrice5,BidPrice6,BidPrice7,BidPrice8,BidPrice9, BidOrderQty0,BidOrderQty1,BidOrderQty2,BidOrderQty3,BidOrderQty4,BidOrderQty5,BidOrderQty6,BidOrderQty7,BidOrderQty8,BidOrderQty9,OfferPrice0,OfferPrice1,OfferPrice2,OfferPrice3,OfferPrice4,OfferPrice5,OfferPrice6,OfferPrice7,OfferPrice8,OfferPrice9,OfferOrderQty0,OfferOrderQty1,OfferOrderQty2,OfferOrderQty3,OfferOrderQty4,OfferOrderQty5,OfferOrderQty6,OfferOrderQty7,OfferOrderQty8,OfferOrderQty9)) as Press, sqrt(sum(pow((log((BidPrice0*OfferOrderQty0+OfferPrice0*BidOrderQty0)\(BidOrderQty0+OfferOrderQty0))-prev(log((BidPrice0*OfferOrderQty0+OfferPrice0*BidOrderQty0)\(BidOrderQty0+OfferOrderQty0)))),2))) as RV from snapshot where date(TradeTime) between 2020.01.01 : 2020.12.31, SecurityID in stockList, (time(TradeTime) between 09:30:00.000 : 11:29:59.999) || (time(TradeTime) between 13:00:00.000 : 14:56:59.999) group by SecurityID, interval( TradeTime, 10m, &#34;none&#34; ) as TradeTime&lt;/codeblock&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:20;144:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;上述 SQL 中，涉及&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:2;144:12&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;BidPrice0-9&lt;/codeph&gt;、&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:3;144:26&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;BidOrderQty0-9&lt;/codeph&gt;、&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:4;144:43&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OfferPrice0-9&lt;/codeph&gt;、&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:5;144:59&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OfferOrderQty0-9&lt;/codeph&gt;共 40 列数据，且由于指标定义较为复杂，即使公式化简后，仍然难以解决代码冗长、修改困难的问题。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:21;146:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;计算处理效率：&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:5;148:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:10;148:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;分布式表数据总量：2,874,861,174&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:11;149:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;上证 50 指数的成分股数据量：58,257,708&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:12;150:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;逻辑 CPU 核数：8&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:13;151:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;平均占用 CPU 核心数：4.5 个&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:14;152:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;耗时：450 秒&lt;/li&gt;&lt;/ul&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;32-进阶将列拼接为矩阵进行计算&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:6;154:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:6;154:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;3.2. 进阶：将列拼接为矩阵进行计算&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:6;154:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:22;156:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;数据采用 OLAP 存储引擎存储。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:23;158:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;上述公式定义中都是列与列之间的计算，实际计算往往发生在&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:6;158:28&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;BidPrice&lt;/codeph&gt;，&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:7;158:39&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;BidOrderQty&lt;/codeph&gt;，&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:8;158:53&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OfferPrice&lt;/codeph&gt;，&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:9;158:66&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OfferOrderQty&lt;/codeph&gt;这 4 个大组之间（每组 10 列），因此可以将这四个大组看成 n 行 10 列的矩阵。在 SQL 中进行 matrix 拼接，再传入聚合函数中进行矩阵运算，示例代码如下：&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:5;160:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;/** part1: Define calculation function */ defg featureEngine(bidPrice,bidQty,offerPrice,offerQty){ bas = offerPrice[0]\bidPrice[0]-1 wap = (bidPrice[0]*offerQty[0] + offerPrice[0]*bidQty[0])\(bidQty[0]+offerQty[0]) di = (bidQty-offerQty)\(bidQty+offerQty) bidw=(1.0\(bidPrice-wap)) bidw=bidw\(bidw.rowSum()) offerw=(1.0\(offerPrice-wap)) offerw=offerw\(offerw.rowSum()) press=log((bidQty*bidw).rowSum())-log((offerQty*offerw).rowSum()) rv=sqrt(sum2(log(wap)-log(prev(wap)))) return avg(bas),avg(di[0]),avg(di[1]),avg(di[2]),avg(di[3]),avg(di[4]),avg(di[5]),avg(di[6]),avg(di[7]),avg(di[8]),avg(di[9]),avg(press),rv } /** part2: Define variables and assign values */ stockList=`601318`600519`600036`600276`601166`600030`600887`600016`601328`601288`600000`600585`601398`600031`601668`600048`601888`600837`601601`601012`603259`601688`600309`601988`601211`600009`600104`600690`601818`600703`600028`601088`600050`601628`601857`601186`600547`601989`601336`600196`603993`601138`601066`601236`601319`603160`600588`601816`601658`600745 dbName = &#34;dfs://snapshot_SH_L2_OLAP&#34; tableName = &#34;snapshot_SH_L2_OLAP&#34; snapshot = loadTable(dbName, tableName) /** part3: Execute SQL */ result1 = select featureEngine( matrix(BidPrice0,BidPrice1,BidPrice2,BidPrice3,BidPrice4,BidPrice5,BidPrice6,BidPrice7,BidPrice8,BidPrice9), matrix(BidOrderQty0,BidOrderQty1,BidOrderQty2,BidOrderQty3,BidOrderQty4,BidOrderQty5,BidOrderQty6,BidOrderQty7, BidOrderQty8,BidOrderQty9), matrix(OfferPrice0,OfferPrice1,OfferPrice2,OfferPrice3,OfferPrice4,OfferPrice5,OfferPrice6,OfferPrice7,OfferPrice8, OfferPrice9), matrix(OfferOrderQty0,OfferOrderQty1,OfferOrderQty2,OfferOrderQty3,OfferOrderQty4,OfferOrderQty5,OfferOrderQty6, OfferOrderQty7,OfferOrderQty8,OfferOrderQty9)) as `BAS`DI0`DI1`DI2`DI3`DI4`DI5`DI6`DI7`DI8`DI9`Press`RV from snapshot where date(TradeTime) between 2020.01.01 : 2020.12.31, SecurityID in stockList, (time(TradeTime) between 09:30:00.000 : 11:29:59.999) || (time(TradeTime) between 13:00:00.000 : 14:56:59.999) group by SecurityID, interval( TradeTime, 10m, &#34;none&#34; ) as TradeTime map&lt;/codeblock&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:24;199:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;通过矩阵化处理，代码大量减少，且在自定义聚合函数中已经可以比较容易的看出指标公式的计算代码，这将极大地方便后续公式定义和指标计算代码的修改。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:25;201:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;计算处理效率：&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:6;203:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:15;203:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;分布式表数据总量：2,874,861,174&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:16;204:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;上证 50 指数的成分股数据量：58,257,708&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:17;205:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;逻辑 CPU 核数：8&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:18;206:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;平均占用 CPU 核心数：4.5 个&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:19;207:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;耗时：450 秒&lt;/li&gt;&lt;/ul&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;33-高性能-1tsdb-存储和计算&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:7;209:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:7;209:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;3.3. 高性能 1：TSDB 存储和计算&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:7;209:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:26;211:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;DolphinDB v2.00 新增了 TSDB 存储引擎，在创建分区数据库和表时与 OLAP 存储引擎的不同之处是必须指定 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:10;211:64&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;engine&lt;/codeph&gt; 和 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:11;211:75&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;sortColumns&lt;/codeph&gt;，创建语句如下：&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:6;213:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;dbName = &#34;dfs://snapshot_SH_L2_TSDB&#34; tableName = &#34;snapshot_SH_L2_TSDB&#34; dbTime = database(, VALUE, 2020.01.01..2020.12.31) dbSymbol = database(, HASH, [SYMBOL, 20]) db = database(dbName, COMPO, [dbTime, dbSymbol], engine='TSDB') createPartitionedTable(dbHandle=db, table=tbTemp, tableName=tableName, partitionColumns=`TradeTime`SecurityID, sortColumns=`SecurityID`TradeTime)&lt;/codeblock&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:27;222:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;计算代码与前述进阶代码完全相同。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:28;224:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;由于 TSDB 存储引擎的查询优化，数据计算性能得到了极大地提升。原来需要运行 450 秒完成的计算，优化后只需运行 27 秒，计算速度是未优化代码的 17 倍。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:29;226:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;计算处理效率：&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:7;228:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:20;228:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;分布式表数据总量：2,874,861,174&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:21;229:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;上证 50 指数的成分股数据量：58,257,708&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:22;230:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;逻辑 CPU 核数：8&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:23;231:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;平均占用 CPU 核心数：7.6 个&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:24;232:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;无 level file 索引缓存下的计算耗时：27 秒&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:25;233:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;有 level file 索引缓存下的计算耗时：16 秒&lt;/li&gt;&lt;/ul&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;34-高性能-2在-tsdb-中使用数组向量存储和计算&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:8;235:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:8;235:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;3.4. 高性能 2：在 TSDB 中使用数组向量存储和计算&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:8;235:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:30;237:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;DolphinDB 从 v2.00.4 开始，分布式表的存储支持数组向量 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:12;237:38&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;array vector&lt;/codeph&gt;，因此在数据存储时可以把&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:13;237:64&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;BidPrice0-9&lt;/codeph&gt;、&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:14;237:78&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;BidOrderQty0-9&lt;/codeph&gt;、&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:15;237:95&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OfferPrice0-9&lt;/codeph&gt;、&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:16;237:111&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OfferOrderQty0-9&lt;/codeph&gt;共 40 列数据以 array vector 形式存储为&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:17;237:157&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;BidPrice&lt;/codeph&gt;、&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:18;237:168&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;BidOrderQty&lt;/codeph&gt;、&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:19;237:182&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OfferPrice&lt;/codeph&gt;、&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:20;237:195&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OfferOrderQty&lt;/codeph&gt;4 列，SQL 的示例代码如下：&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:7;239:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;/** part1: Define calculation function */ defg featureEngine(bidPrice,bidQty,offerPrice,offerQty){ bas = offerPrice[0]\bidPrice[0]-1 wap = (bidPrice[0]*offerQty[0] + offerPrice[0]*bidQty[0])\(bidQty[0]+offerQty[0]) di = (bidQty-offerQty)\(bidQty+offerQty) bidw=(1.0\(bidPrice-wap)) bidw=bidw\(bidw.rowSum()) offerw=(1.0\(offerPrice-wap)) offerw=offerw\(offerw.rowSum()) press=log((bidQty*bidw).rowSum())-log((offerQty*offerw).rowSum()) rv=sqrt(sum2(log(wap)-log(prev(wap)))) return avg(bas),avg(di[0]),avg(di[1]),avg(di[2]),avg(di[3]),avg(di[4]),avg(di[5]),avg(di[6]),avg(di[7]),avg(di[8]),avg(di[9]),avg(press),rv } /** part2: Define variables and assign values */ stockList=`601318`600519`600036`600276`601166`600030`600887`600016`601328`601288`600000`600585`601398`600031`601668`600048`601888`600837`601601`601012`603259`601688`600309`601988`601211`600009`600104`600690`601818`600703`600028`601088`600050`601628`601857`601186`600547`601989`601336`600196`603993`601138`601066`601236`601319`603160`600588`601816`601658`600745 dbName = &#34;dfs://snapshot_SH_L2_TSDB_ArrayVector&#34; tableName = &#34;snapshot_SH_L2_TSDB_ArrayVector&#34; snapshot = loadTable(dbName, tableName) /** part3: Execute SQL */ result = select featureEngine(BidPrice,BidOrderQty,OfferPrice,OfferOrderQty) as `BAS`DI0`DI1`DI2`DI3`DI4`DI5`DI6`DI7`DI8`DI9`Press`RV from snapshot where date(TradeTime) between 2020.01.01 : 2020.12.31, SecurityID in stockList, (time(TradeTime) between 09:30:00.000 : 11:29:59.999) || (time(TradeTime) between 13:00:00.000 : 14:56:59.999) group by SecurityID, interval( TradeTime, 10m, &#34;none&#34; ) as TradeTime map&lt;/codeblock&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:31;274:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;使用 TSDB 的 array vector 进行数据存储，在性能上相较于 TSDB 的分列存储提升不明显，但是代码更加精简，方便后期的修改和维护。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:32;276:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;计算效率：&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:8;278:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:26;278:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;分布式表数据总量：2,874,861,174&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:27;279:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;上证 50 指数的成分股数据量：58,257,708&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:28;280:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;逻辑 CPU 核数：8&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:29;281:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;平均占用 CPU 核心数：7.6 个&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:30;282:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;无 level file 索引缓存下的计算耗时：25 秒&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:31;283:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;有 level file 索引缓存下的计算耗时：15 秒&lt;/li&gt;&lt;/ul&gt;&lt;/body&gt;&lt;/topic&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;4-olap-到-tsdb-的性能提升原因&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:9;285:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:9;285:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;4. OLAP 到 TSDB 的性能提升原因&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:9;285:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;/&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;41-数据库分区方法&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:10;287:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:10;287:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;4.1. 数据库分区方法&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:10;287:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:33;289:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OLAP 存储引擎创建分区数据库的代码：&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:8;291:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;dbName = &#34;dfs://snapshot_SH_L2_OLAP&#34; dbTime = database(, VALUE, 2020.01.01..2020.12.31) dbSymbol = database(, HASH, [SYMBOL, 20]) db = database(dbName, COMPO, [dbTime, dbSymbol])&lt;/codeblock&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:34;298:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;TSDB 存储引擎创建分区数据库的代码：&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:9;300:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;dbName = &#34;dfs://snapshot_SH_L2_TSDB&#34; dbTime = database(, VALUE, 2020.01.01..2020.12.31) dbSymbol = database(, HASH, [SYMBOL, 20]) db = database(dbName, COMPO, [dbTime, dbSymbol], engine='TSDB')&lt;/codeblock&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:35;307:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;DolphinDB 的分区规则是建立在数据库层面上的，本案例中，OLAP 存储引擎和 TSDB 存储引擎的分区规则相同，第一层按天分区，第二层以证券代码采用哈希算法分 20 个区。因此，14460 个证券每天的数据被相对均匀地存储在 20 个分区内，上证 50 指数成分股的数据也被分散存储在多个分区内；从另一个角度理解，同一个分区内包含多个哈希值相同的证券的数据。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:36;309:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;在 DolphinDB 中，无论是 OLAP 存储引擎还是 TSDB 存储引擎，数据的切片思想和算法是一致的，所以本案例中，数据库创建代码中唯一的差异是，TSDB 存储引擎需要指定参数&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:21;309:93&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;engine&lt;/codeph&gt;为&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:22;309:102&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;TSDB&lt;/codeph&gt;，该参数默认值是&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:23;309:116&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OLAP&lt;/codeph&gt;。&lt;/p&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;42-数据表创建方法&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:11;311:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:11;311:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;4.2. 数据表创建方法&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:11;311:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:37;313:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OLAP 存储引擎创建分区数据表的代码：&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:10;315:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;dbName = &#34;dfs://snapshot_SH_L2_OLAP&#34; db = database(dbName) tableName = &#34;snapshot_SH_L2_OLAP&#34; createPartitionedTable(dbHandle=db, table=tbTemp, tableName=tbName, partitionColumns=`TradeTime`SecurityID)&lt;/codeblock&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:38;322:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;TSDB 存储引擎创建分区数据表的代码：&lt;/p&gt;&lt;codeblock class=&#34;+ topic/pre pr-d/codeblock &#34; xml:space=&#34;preserve&#34; xtrc=&#34;codeblock:11;324:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;dbName = &#34;dfs://snapshot_SH_L2_TSDB&#34; db = database(dbName) tableName = &#34;snapshot_SH_L2_TSDB&#34; createPartitionedTable(dbHandle=db, table=tbTemp, tableName=tableName, partitionColumns=`TradeTime`SecurityID, sortColumns=`SecurityID`TradeTime)&lt;/codeblock&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:39;331:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;在使用 TSDB 存储引擎创建分区数据表时，设置了&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:24;331:26&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;sortColumns=&lt;/codeph&gt;SecurityID&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:25;331:50&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;TradeTime&lt;/codeph&gt;，&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:26;331:62&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;sortColumns&lt;/codeph&gt;一般由两部分组成：&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:9;333:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:32;333:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:27;333:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;sortKey&lt;/codeph&gt;：可以由一个或多个查询索引列组成，不包含数据的时间列&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:33;334:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;时间列：数据中的时间列，作为分区内数据按时间顺序的排序列&lt;/li&gt;&lt;/ul&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:40;336:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;本案例中，&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:28;336:6&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;sortKey=&lt;/codeph&gt;SecurityID&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:29;336:26&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;，时间列为&lt;/codeph&gt;TradeTime&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:30;336:42&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;。与OLAP存储引擎相比，TSDB存储的每个分区中的同一&lt;/codeph&gt;SecurityID&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:31;336:82&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;的数据在磁盘文件中是连续的，且按照&lt;/codeph&gt;TradeTime&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:32;336:110&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;严格排序。相比于OLAP存储引擎，TSDB存储引擎在根据&lt;/codeph&gt;sortColumes`字段进行数据过滤查询时，可以根据分区内的索引文件从磁盘上只加载满足过滤条件的数据。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:41;338:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;本案例的计算样本是 2020 年上证 50 指数成分股，计算数据源是 2020 年上交所 14460 个证券的全部数据。如果采用 OLAP 存储引擎，需要将上证 50 指数成分股涉及的分区内的无关证券的数据同时从磁盘上加载到内存后，进行数据的解压、过滤和计算操作。如果采用 TSDB，只需要将上证 50 指数成分股的数据从磁盘上加载到内存，进行数据的计算操作。&lt;/p&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;43-olap-存储引擎与-tsdb-存储引擎的差异&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:12;340:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:12;340:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;4.3. OLAP 存储引擎与 TSDB 存储引擎的差异&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:12;340:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:42;342:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;OLAP 存储引擎保持了数据写入时的顺序，以一种 append-only 的方式往磁盘上存储数据。分区表的每个分区内的每个列是一个文件，对于某个列文件而言，多个&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:33;342:81&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;SecurityID&lt;/codeph&gt;的数据是根据数据写入顺序添加到文件中的，所以同一个&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:34;342:118&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;SecurityID&lt;/codeph&gt;的数据很大概率是散乱地分布在整个列文件的各个位置。本案例中，查询数据表存储了 14460 个证券的数据，虽然只查询上证 50 指数成分股的数据，但是在 OLAP 存储引擎下，会将上证 50 指数成分股涉及的分区内的无关证券的数据同时从磁盘上读取到内存进行解压，降低了数据提取的效率。&lt;/p&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:43;344:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;TSDB 存储引擎设置了&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:35;344:13&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;sortColumns=`SecurityID`TradeTime&lt;/codeph&gt;，对同一个&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:36;344:57&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;SecurityID&lt;/codeph&gt;的数据的存储是连续的，且存储的时候需要压缩：&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:10;346:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:34;346:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;如果将同一个&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:37;346:9&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;SecurityID&lt;/codeph&gt;的所有数据一起压缩，那每次查询的时候，即便真正需要查询的数据只是这个&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:38;346:55&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;SecurityID&lt;/codeph&gt;全部数据的一小部分，仍然需要将所有的数据都从磁盘读到内存中以进行解压，降低数据读取效率。&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:35;347:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;TSDB 存储引擎的做法是将同一个&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:39;347:20&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;SecurityID&lt;/codeph&gt;在同一个 LevelFile 里的全部数据一起压缩存储，并且指定一个时间区间以供查询，而这个时间区间内的数据只占据了这个&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:40;347:92&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;SecurityID&lt;/codeph&gt;所有数据的一小部分。在本案例中，同一个&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:41;347:123&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;SecurityID&lt;/codeph&gt;的数据根据&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:42;347:140&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;sortColumns&lt;/codeph&gt;最后一列&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:43;347:157&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;TradeTime&lt;/codeph&gt;排序，并将数据拆成一定大小（默认为 16KB）的数据块（block）来存储。在读取数据的时候，TSDB 根据查询语句中的股票列和时间列过滤条件先快速定位到满足过滤条件的数据块，再将这些数据块读到内存里进行解压，而这些数据块通常只占所有数据的一小部分，这样就可以大大提升查询的效率。&lt;/li&gt;&lt;/ul&gt;&lt;image class=&#34;- topic/image &#34; href=&#34;images/sql_performance_optimization_wap_di_rv/levelFileBlock.png&#34; placement=&#34;break&#34; xtrc=&#34;image:6;349:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34; dita-ot:image-width=&#34;724&#34; dita-ot:image-height=&#34;435&#34; dita-ot:horizontal-dpi=&#34;96&#34; dita-ot:vertical-dpi=&#34;96&#34;&gt;&lt;alt class=&#34;- topic/alt &#34; xtrc=&#34;alt:1;349:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;fileblocklevel&lt;/alt&gt;&lt;/image&gt;&lt;/body&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;44-小结&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:13;351:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:13;351:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;4.4. 小结&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:13;351:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:44;353:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;本案例中，使用 TSDB 存储引擎比 OLAP 存储引擎计算性能提升的主要原因如下：&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:11;355:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:36;355:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:45;355:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;本案例计算场景中，查询数据表中存储了上交所 2020 年所有证券的 Level-2 快照数据，14,460 个证券共 2,874,861,174 条数据。计算的样本数据为 2020 年上证 50 指数的成分股，共 58,257,708 条数据。在没有任何缓存的前提下，与 OLAP 存储引擎相比，TSDB 存储引擎仅仅只需要去磁盘上读取 58,257,708 条数据。&lt;/p&gt;&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:37;357:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:46;357:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;DolphinDB 从 v2.00.4 开始，分布式表的存储支持数组向量（&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:44;357:40&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;array vector&lt;/codeph&gt;），特别适用于金融快照数据多档量价数据的存储。针对上交所 level2 快照数据，采用 array vector 存储后，压缩比可以提升到 9~11。在没有任何缓存的前提下，与多列存储方案相比，采用 TSDB 的 array vector 存储后，单位时间内从磁盘上读取的数据条数提升。&lt;/p&gt;&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:38;359:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:47;359:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;Level-2 快照数据中的多档量价数据采用 DolphinDB TSDB 存储引擎的 &lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:45;359:47&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;array vector&lt;/codeph&gt; 存储后，从某种意义上实现了数据的三维存储，即在分布式表的某列某行中存储了一个向量对象，所以在对多档量价数据做矩阵运算时，取某一列的多行数据返回的对象就是一个矩阵，与多列存储方案相比，省去了矩阵拼接的过程。&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/body&gt;&lt;/topic&gt;&lt;/topic&gt;&lt;topic class=&#34;- topic/topic &#34; ditaarch:DITAArchVersion=&#34;2.0&#34; domains=&#34;a(props audience) a(props deliveryTarget) a(props otherprops) a(props platform) a(props product)&#34; id=&#34;5-总结&#34; specializations=&#34;@props/audience @props/deliveryTarget @props/otherprops @props/platform @props/product&#34; xtrc=&#34;topic:14;361:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;title class=&#34;- topic/title &#34; xtrc=&#34;title:14;361:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;5. 总结&lt;/title&gt;&lt;body class=&#34;- topic/body &#34; xtrc=&#34;body:14;361:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:48;363:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;本案例基于同一个计算场景，开发了 4 份 SQL 代码：&lt;/p&gt;&lt;ul class=&#34;- topic/ul &#34; xtrc=&#34;ul:12;365:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:39;365:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;b class=&#34;+ topic/ph hi-d/b &#34; xtrc=&#34;b:7;365:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;新手篇&lt;/b&gt;代码数据存储采用 DolphinDB 的 OLAP 存储引擎，基于列式计算思想，代码开发难度简单，但是存在代码冗长、修改困难的问题，计算时间为 450 秒。&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:40;366:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;b class=&#34;+ topic/ph hi-d/b &#34; xtrc=&#34;b:8;366:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;进阶篇&lt;/b&gt;代码数据存储采用 DolphinDB 的 OLAP 存储引擎，基于矩阵计算思想，代码开发难度一般，代码量减少，计算逻辑表达更加清晰，计算耗时为 450 秒。&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:41;367:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;b class=&#34;+ topic/ph hi-d/b &#34; xtrc=&#34;b:9;367:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;高性能 1 篇&lt;/b&gt;代码数据存储采用 DolphinDB 的 TSDB 存储引擎，基于矩阵计算思想，脚本代码与进阶篇代码完全相同，无 level file 索引缓存下计算耗时为 27 秒，有 level file 索引缓存下计算耗时为 16 秒。&lt;/li&gt;&lt;li class=&#34;- topic/li &#34; xtrc=&#34;li:42;368:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;&lt;b class=&#34;+ topic/ph hi-d/b &#34; xtrc=&#34;b:10;368:3&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;高性能 2 篇&lt;/b&gt;代码数据存储采用 DolphinDB 的 TSDB 存储引擎，且多档量价数据采用&lt;codeph class=&#34;+ topic/ph pr-d/codeph &#34; xtrc=&#34;codeph:46;368:54&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;array vector&lt;/codeph&gt;进行存储，基于矩阵计算思想，代码精简，方便后期的修改和维护，无 level file 索引缓存下计算耗时为 25 秒，有 level file 索引缓存下计算耗时为 15 秒。&lt;/li&gt;&lt;/ul&gt;&lt;p class=&#34;- topic/p &#34; xtrc=&#34;p:49;370:1&#34; xtrf=&#34;file:/var/lib/jenkins/workspace/packDocCN/documentation/zh/tutorials/sql_performance_optimization_wap_di_rv.md&#34;&gt;旨在为 DolphinDB 使用者在开发其他类似因子计算脚本时提供参考范例，提高开发效率。&lt;/p&gt;&lt;/body&gt;&lt;/topic&gt;&lt;/topic&gt;"/><meta name="wh-source-relpath" content="tutorials/sql_performance_optimization_wap_di_rv.md"/><meta name="wh-out-relpath" content="tutorials/sql_performance_optimization_wap_di_rv.html"/>

    <link rel="stylesheet" type="text/css" href="../oxygen-webhelp/app/commons.css?buildId=2024012323"/>
    <link rel="stylesheet" type="text/css" href="../oxygen-webhelp/app/topic.css?buildId=2024012323"/>

    <script src="../oxygen-webhelp/app/options/properties.js?buildId=20240704100525"></script>
    <script src="../oxygen-webhelp/app/localization/strings.js?buildId=2024012323"></script>
    <script src="../oxygen-webhelp/app/search/index/keywords.js?buildId=20240704100525"></script>
    <script defer="defer" src="../oxygen-webhelp/app/commons.js?buildId=2024012323"></script>
    <script defer="defer" src="../oxygen-webhelp/app/topic.js?buildId=2024012323"></script>
<link rel="stylesheet" type="text/css" href="../oxygen-webhelp/template/styles.css?buildId=2024012323"/><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script></head>

    <body id="深度不平衡买卖压力指标波动率计算" class="wh_topic_page frmBody">
        <a href="#wh_topic_body" class="sr-only sr-only-focusable">
            跳转到主要内容
        </a>
        
        
        
        
        <header class="navbar navbar-default wh_header">
    <div class="container-fluid">
        <div xmlns:whc="http://www.oxygenxml.com/webhelp/components" class="wh_header_flex_container navbar-nav navbar-expand-md navbar-dark">
            <div class="wh_logo_and_publication_title_container">
                <div class="wh_logo_and_publication_title">
                    
                    <a href="https://www.dolphindb.cn" class=" wh_logo d-none d-sm-block "><img src="../logo.png" alt="  DolphinDB 文档中心  "/></a>
                    <div class=" wh_publication_title "><a href="../index.html"><span class="booktitle">  <span class="ph mainbooktitle">DolphinDB 文档中心</span>  </span></a></div>
                    
                </div>
                
                
            </div>

            <div class="wh_top_menu_and_indexterms_link collapse navbar-collapse" id="wh_top_menu_and_indexterms_link">
                
                
                
                
            </div>
        <div class=" wh_search_input navbar-form wh_topic_page_search search " role="form">
            
            
            
            <form id="searchForm" method="get" role="search" action="../search.html"><div><input type="search" placeholder="搜索 " class="wh_search_textfield" id="textToSearch" name="searchQuery" aria-label="搜索查询" required="required"/><button type="submit" class="wh_search_button" aria-label="搜索"><span class="search_input_text">搜索</span></button></div></form>
            
            <script src="/vendors/react/umd/react.production.min.js" defer="defer"></script>
<script src="/vendors/react-dom/umd/react-dom.production.min.js" defer="defer"></script>
<script src="/vendors/dayjs/dayjs.min.js" defer="defer"></script>
<script src="/vendors/antd/dist/antd.min.js" defer="defer"></script>
<script src="/vendors/@ant-design/icons/dist/index.umd.min.js" defer="defer"></script>
<script src="/zh/index.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" defer="defer"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer="defer"><!--


--></script>

            
        </div></div>
    </div>
</header>
        
        
         
        
        
        
        <div class="container-fluid" id="wh_topic_container">
            <div class="row">

                <nav class="wh_tools d-print-none navbar-expand-md" aria-label="Tools">
                    
                    <div data-tooltip-position="bottom" class=" wh_breadcrumb "><ol class="d-print-none"><li><span class="home"><a href="../index.html"><span>主页</span></a></span></li><li><div class="topicref" data-id="about_tutorials"><div class="title"><a href="../tutorials/about_tutorials.html"><span class="keyword label">教程</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 产品使用教程</p></div></div></div></li><li><div class="topicref"><div class="title"><a href="../tutorials/dolphinscheduler_integration.html">金融场景案例</a></div></div></li><li class="active"><div class="topicref" data-id="深度不平衡买卖压力指标波动率计算"><div class="title"><a href="../tutorials/sql_performance_optimization_wap_di_rv.html">深度不平衡、买卖压力指标、波动率计算</a></div></div></li></ol></div>
                    
                    
                    
                    <div class="wh_right_tools">
                        <button class="wh_hide_highlight" aria-label="切换搜索突出显示" title="切换搜索突出显示"></button>
                        <button class="webhelp_expand_collapse_sections" data-next-state="collapsed" aria-label="折叠截面" title="折叠截面"></button>
                        
                        
                        
                        
                        <div class=" wh_print_link print d-none d-md-inline-block "><button onClick="window.print()" title="打印此页" aria-label="打印此页"></button></div>
                        
                        <button type="button" id="wh_toc_button" class="custom-toggler navbar-toggler collapsed wh_toggle_button navbar-light" aria-expanded="false" aria-label="Toggle publishing table of content" aria-controls="wh_publication_toc">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                    </div>
                    
                </nav>
            </div>
            
            
            
            
            <div class="wh_content_area">
                <div class="row">
                    
                        <nav id="wh_publication_toc" class="col-lg-3 col-md-3 col-sm-12 d-md-block d-none d-print-none" aria-label="Table of Contents Container">
                            <div id="wh_publication_toc_content">
		                        
                            	<div class=" wh_publication_toc " data-tooltip-position="right"><span class="expand-button-action-labels"><span id="button-expand-action" role="button" aria-label="Expand"></span><span id="button-collapse-action" role="button" aria-label="Collapse"></span><span id="button-pending-action" role="button" aria-label="Pending"></span></span><ul role="tree" aria-label="Table of Contents"><li role="treeitem"><div data-tocid="new_chap_about_sect_ddb_docs_intro-d9529e87" class="topicref" data-id="new_chap_about_sect_ddb_docs_intro" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../about/ddb_docs_intro.html" id="new_chap_about_sect_ddb_docs_intro-d9529e87-link">文档使用说明</a><div class="wh-tooltip"><p class="shortdesc">如何获取 DolphinDB 帮助信息</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="chap1_getstarted-d9529e140" class="topicref" data-id="chap1_getstarted" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action chap1_getstarted-d9529e140-link" class="wh-expand-btn"></span><div class="title"><a href="../getstarted/chap1_getstarted.html" id="chap1_getstarted-d9529e140-link"><span class="keyword label">快速上手</span></a><div class="wh-tooltip"><p class="shortdesc">如何快速部署 DolphinDB、建库建表、写入和查询数据</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="sectionddb_deployment-d9529e335" class="topicref" data-id="sectionddb_deployment" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action sectionddb_deployment-d9529e335-link" class="wh-expand-btn"></span><div class="title"><a href="../deploy/deploy_intro.html" id="sectionddb_deployment-d9529e335-link"><span class="keyword label">部署</span></a><div class="wh-tooltip"><p class="shortdesc">如何在不同的场景中部署 DolphinDB</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="new_chap_database_manage_new_chap_dbmanage_landing_page-d9529e2313" class="topicref" data-id="new_chap_database_manage_new_chap_dbmanage_landing_page" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action new_chap_database_manage_new_chap_dbmanage_landing_page-d9529e2313-link" class="wh-expand-btn"></span><div class="title"><a href="../db_distr_comp/cfg/db_intro.html" id="new_chap_database_manage_new_chap_dbmanage_landing_page-d9529e2313-link"><span class="keyword label">数据库</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 数据库的基本概念</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="chap7_tutorials_streaming-d9529e3490" class="topicref" data-id="chap7_tutorials_streaming" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action chap7_tutorials_streaming-d9529e3490-link" class="wh-expand-btn"></span><div class="title"><a href="../stream/str_intro.html" id="chap7_tutorials_streaming-d9529e3490-link"><span class="keyword label">流数据</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 流数据引擎及流数据计算的基本概念</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e7385" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e7385-link" class="wh-expand-btn"></span><div class="title"><a href="../db_distr_comp/db_oper/import_data.html" id="tocId-d9529e7385-link">数据迁移</a><div class="wh-tooltip"><p class="shortdesc">如何从不同数据源向 DolphinDB 迁移数据</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="chap7_tutorials_system_management-d9529e7812" class="topicref" data-id="chap7_tutorials_system_management" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action chap7_tutorials_system_management-d9529e7812-link" class="wh-expand-btn"></span><div class="title"><a href="../sys_man/om_intro.html" id="chap7_tutorials_system_management-d9529e7812-link"><span class="keyword label">系统运维</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 的系统运维功能及方法</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="about_language_resources-d9529e16490" class="topicref" data-id="about_language_resources" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action about_language_resources-d9529e16490-link" class="wh-expand-btn"></span><div class="title"><a href="../progr/progr_intro.html" id="about_language_resources-d9529e16490-link"><span class="keyword label">编程语言</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 编程基本概念与方法、SQL 在 DolphinDB 的应用</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="functions_references-d9529e26503" class="topicref" data-id="functions_references" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action functions_references-d9529e26503-link" class="wh-expand-btn"></span><div class="title"><a href="../funcs/funcs_intro.html" id="functions_references-d9529e26503-link"><span class="keyword label">函数参考</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 函数分类、语法、详解及示例</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="api_protocol-d9529e86456" class="topicref" data-id="api_protocol" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action api_protocol-d9529e86456-link" class="wh-expand-btn"></span><div class="title"><a href="../api/connapi_intro.html" id="api_protocol-d9529e86456-link"><span class="keyword label">连接器 &amp; API</span></a><div class="wh-tooltip"><p class="shortdesc">面向不同编程语言的 DolphinDB API 及连接器，相关协议和用法</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="chap6_plugin-d9529e91976" class="topicref" data-id="chap6_plugin" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action chap6_plugin-d9529e91976-link" class="wh-expand-btn"></span><div class="title"><a href="../plugins/plg_intro.html" id="chap6_plugin-d9529e91976-link"><span class="keyword label">插件</span></a><div class="wh-tooltip"><p class="shortdesc">多个应用场景的插件使用说明和插件开发指导</p></div></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="third_party-d9529e94749" class="topicref" data-id="third_party" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action third_party-d9529e94749-link" class="wh-expand-btn"></span><div class="title"><a href="../third_party.html" id="third_party-d9529e94749-link">第三方工具</a></div></div></li><li role="treeitem" aria-expanded="true"><div data-tocid="about_tutorials-d9529e94980" class="topicref" data-id="about_tutorials" data-state="expanded"><span role="button" tabindex="0" aria-labelledby="button-collapse-action about_tutorials-d9529e94980-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/about_tutorials.html" id="about_tutorials-d9529e94980-link"><span class="keyword label">教程</span></a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 产品使用教程</p></div></div></div><ul role="group" class="navbar-nav nav-list"><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e95033" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e95033-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/import_data.html" id="tocId-d9529e95033-link">数据导入</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e95264" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e95264-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/DolphinDB_TopN.html" id="tocId-d9529e95264-link">数据库</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e95910" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e95910-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/memory_management.html" id="tocId-d9529e95910-link">系统运维</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e96325" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e96325-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/hybrid_programming_paradigms.html" id="tocId-d9529e96325-link">编程语言</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e97155" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e97155-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/data_sync_among_clusters.html" id="tocId-d9529e97155-link">安全与容灾</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e97386" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e97386-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/streaming_tutorial.html" id="tocId-d9529e97386-link">流数据</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e97893" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e97893-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/DECIMAL.html" id="tocId-d9529e97893-link">数值处理</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="chap7_tutorials_modules-d9529e97986" class="topicref" data-id="chap7_tutorials_modules" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action chap7_tutorials_modules-d9529e97986-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/tu_modules.html" id="chap7_tutorials_modules-d9529e97986-link"><span class="keyword label">模块</span></a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="plugins_apply-d9529e98493" class="topicref" data-id="plugins_apply" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action plugins_apply-d9529e98493-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/plugins_apply.html" id="plugins_apply-d9529e98493-link">插件应用</a></div></div></li><li role="treeitem" aria-expanded="true"><div data-tocid="tocId-d9529e98631" class="topicref" data-state="expanded"><span role="button" tabindex="0" aria-labelledby="button-collapse-action tocId-d9529e98631-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/dolphinscheduler_integration.html" id="tocId-d9529e98631-link">金融场景案例</a></div></div><ul role="group" class="navbar-nav nav-list"><li role="treeitem"><div data-tocid="dolphindb-与-dolphinscheduler-的集成-d9529e98632" class="topicref" data-id="dolphindb-与-dolphinscheduler-的集成" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/dolphinscheduler_integration.html" id="dolphindb-与-dolphinscheduler-的集成-d9529e98632-link">DolphinDB 与 DolphinScheduler 的集成</a></div></div></li><li role="treeitem"><div data-tocid="gplearn-d9529e98678" class="topicref" data-id="gplearn" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/gplearn.html" id="gplearn-d9529e98678-link">Shark GPLearn 快速上手</a></div></div></li><li role="treeitem"><div data-tocid="量化金融范例-d9529e98724" class="topicref" data-id="量化金融范例" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/quant_finance_examples.html" id="量化金融范例-d9529e98724-link">量化金融范例</a></div></div></li><li role="treeitem"><div data-tocid="利用缓存表快速实现-mysql-库间信息同步-d9529e98770" class="topicref" data-id="利用缓存表快速实现-mysql-库间信息同步" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/cachedtable.html" id="利用缓存表快速实现-mysql-库间信息同步-d9529e98770-link">利用缓存表快速实现 MySQL 库间信息同步</a></div></div></li><li role="treeitem"><div data-tocid="机器学习-d9529e98816" class="topicref" data-id="机器学习" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/machine_learning.html" id="机器学习-d9529e98816-link">机器学习</a></div></div></li><li role="treeitem"><div data-tocid="时区处理-d9529e98862" class="topicref" data-id="时区处理" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/timezone.html" id="时区处理-d9529e98862-link">时区处理</a></div></div></li><li role="treeitem"><div data-tocid="实时计算高频因子-d9529e98908" class="topicref" data-id="实时计算高频因子" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/hf_factor_streaming_2.html" id="实时计算高频因子-d9529e98908-link">实时计算高频因子</a></div></div></li><li role="treeitem"><div data-tocid="计算基金日频因子-d9529e98954" class="topicref" data-id="计算基金日频因子" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/fund_factor_contrasted_by_py.html" id="计算基金日频因子-d9529e98954-link">计算基金日频因子</a></div></div></li><li role="treeitem"><div data-tocid="因子计算最佳实践-d9529e99000" class="topicref" data-id="因子计算最佳实践" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/best_practice_for_factor_calculation.html" id="因子计算最佳实践-d9529e99000-link">因子计算最佳实践</a></div></div></li><li role="treeitem"><div data-tocid="因子计算平台构建-d9529e99046" class="topicref" data-id="因子计算平台构建" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/Python_Celery.html" id="因子计算平台构建-d9529e99046-link">因子计算平台构建</a></div></div></li><li role="treeitem"><div data-tocid="金融因子流式实现-d9529e99092" class="topicref" data-id="金融因子流式实现" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/str_comp_fin_quant_2.html" id="金融因子流式实现-d9529e99092-link">金融因子流式实现</a></div></div></li><li role="treeitem"><div data-tocid="中高频多因子库存储最佳实践-d9529e99139" class="topicref" data-id="中高频多因子库存储最佳实践" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/best_practices_for_multi_factor.html" id="中高频多因子库存储最佳实践-d9529e99139-link">中高频多因子库存储最佳实践</a></div></div></li><li role="treeitem"><div data-tocid="python--hdf5-因子计算与-dolphindb-一体化因子计算方案对比-d9529e99185" class="topicref" data-id="python--hdf5-因子计算与-dolphindb-一体化因子计算方案对比" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/Python_HDF5_vs_DolphinDB.html" id="python--hdf5-因子计算与-dolphindb-一体化因子计算方案对比-d9529e99185-link">Python + HDF5 因子计算与 DolphinDB 一体化因子计算方案对比</a></div></div></li><li role="treeitem"><div data-tocid="python--文件存储与-dolphindb-因子计算性能比较-d9529e99231" class="topicref" data-id="python--文件存储与-dolphindb-因子计算性能比较" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/DolphinDB_VS_PythonFile_Storage.html" id="python--文件存储与-dolphindb-因子计算性能比较-d9529e99231-link">Python + 文件存储与 DolphinDB 因子计算性能比较</a></div></div></li><li role="treeitem"><div data-tocid="快速搭建-level-2-快照数据流批一体因子计算平台最佳实践-d9529e99277" class="topicref" data-id="快速搭建-level-2-快照数据流批一体因子计算平台最佳实践" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/l2_snapshot_factor_calc_2.html" id="快速搭建-level-2-快照数据流批一体因子计算平台最佳实践-d9529e99277-link">快速搭建 Level-2 快照数据流批一体因子计算平台最佳实践</a></div></div></li><li role="treeitem"><div data-tocid="k-线计算-d9529e99323" class="topicref" data-id="k-线计算" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/OHLC_2.html" id="k-线计算-d9529e99323-link">K 线计算</a></div></div></li><li role="treeitem"><div data-tocid="mvo_tutorial-d9529e99369" class="topicref" data-id="mvo_tutorial" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/MVO.html" id="mvo_tutorial-d9529e99369-link">优化投资组合：DolphinDB 最优化求解系列函数应用指南</a></div></div></li><li role="treeitem"><div data-tocid="面板数据处理-d9529e99415" class="topicref" data-id="面板数据处理" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/panel_data.html" id="面板数据处理-d9529e99415-link">面板数据处理</a></div></div></li><li role="treeitem"><div data-tocid="快照引擎-d9529e99461" class="topicref" data-id="快照引擎" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/snapshot_engine.html" id="快照引擎-d9529e99461-link">快照引擎</a></div></div></li><li role="treeitem"><div data-tocid="国内股票行情数据导入实例-d9529e99507" class="topicref" data-id="国内股票行情数据导入实例" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/stockdata_csv_import_demo.html" id="国内股票行情数据导入实例-d9529e99507-link">国内股票行情数据导入实例</a></div></div></li><li role="treeitem"><div data-tocid="搭建行情回放服务的最佳实践-d9529e99553" class="topicref" data-id="搭建行情回放服务的最佳实践" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/appendices_market_replay_bp.html" id="搭建行情回放服务的最佳实践-d9529e99553-link">搭建行情回放服务的最佳实践</a></div></div></li><li role="treeitem"><div data-tocid="外汇掉期估值计算-d9529e99599" class="topicref" data-id="外汇掉期估值计算" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/FxSwapValuation.html" id="外汇掉期估值计算-d9529e99599-link">外汇掉期估值计算</a></div></div></li><li role="treeitem" class="active"><div data-tocid="深度不平衡买卖压力指标波动率计算-d9529e99646" class="topicref" data-id="深度不平衡买卖压力指标波动率计算" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/sql_performance_optimization_wap_di_rv.html" id="深度不平衡买卖压力指标波动率计算-d9529e99646-link">深度不平衡、买卖压力指标、波动率计算</a></div></div></li><li role="treeitem"><div data-tocid="金融实时实际波动率预测-d9529e99692" class="topicref" data-id="金融实时实际波动率预测" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/ml_volatility_2.html" id="金融实时实际波动率预测-d9529e99692-link">金融实时实际波动率预测</a></div></div></li><li role="treeitem"><div data-tocid="股票行情回放-d9529e99738" class="topicref" data-id="股票行情回放" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/stock_market_replay_2.html" id="股票行情回放-d9529e99738-link">股票行情回放</a></div></div></li><li role="treeitem"><div data-tocid="实时计算日累计逐单资金流-d9529e99784" class="topicref" data-id="实时计算日累计逐单资金流" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/streaming_capital_flow_daily_2.html" id="实时计算日累计逐单资金流-d9529e99784-link">实时计算日累计逐单资金流</a></div></div></li><li role="treeitem"><div data-tocid="实时计算分钟资金流-d9529e99830" class="topicref" data-id="实时计算分钟资金流" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/streaming_capital_flow_order_by_order_2.html" id="实时计算分钟资金流-d9529e99830-link">实时计算分钟资金流</a></div></div></li><li role="treeitem"><div data-tocid="基金份额参考价值-iopv-计算-d9529e99876" class="topicref" data-id="基金份额参考价值-iopv-计算" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/streaming_IOPV_2.html" id="基金份额参考价值-iopv-计算-d9529e99876-link">基金份额参考价值 IOPV 计算</a></div></div></li><li role="treeitem"><div data-tocid="开发股票波动率预测模型的-676-个输入特征-d9529e99922" class="topicref" data-id="开发股票波动率预测模型的-676-个输入特征" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/metacode_derived_features_2.html" id="开发股票波动率预测模型的-676-个输入特征-d9529e99922-link">开发股票波动率预测模型的 676 个输入特征</a></div></div></li><li role="treeitem"><div data-tocid="流式计算中证-1000-指数主买主卖交易量-d9529e99968" class="topicref" data-id="流式计算中证-1000-指数主买主卖交易量" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/CSI_1000_2.html" id="流式计算中证-1000-指数主买主卖交易量-d9529e99968-link">流式计算中证 1000 指数主买/主卖交易量</a></div></div></li><li role="treeitem"><div data-tocid="利用-dolphindb-高效清洗数据-d9529e100014" class="topicref" data-id="利用-dolphindb-高效清洗数据" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/data_ETL.html" id="利用-dolphindb-高效清洗数据-d9529e100014-link">利用 DolphinDB 高效清洗数据</a></div></div></li><li role="treeitem"><div data-tocid="公募基金历史数据基础分析教程-d9529e100060" class="topicref" data-id="公募基金历史数据基础分析教程" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/public_fund_basic_analysis.html" id="公募基金历史数据基础分析教程-d9529e100060-link">公募基金历史数据基础分析教程</a></div></div></li><li role="treeitem"><div data-tocid="dolphindb-与-python-airflow-最佳实践-d9529e100106" class="topicref" data-id="dolphindb-与-python-airflow-最佳实践" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/ddb_airflow.html" id="dolphindb-与-python-airflow-最佳实践-d9529e100106-link">DolphinDB 与 Python AirFlow 最佳实践</a></div></div></li><li role="treeitem"><div data-tocid="处理-level-2-行情数据实例-d9529e100153" class="topicref" data-id="处理-level-2-行情数据实例" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/l2_stk_data_proc_2.html" id="处理-level-2-行情数据实例-d9529e100153-link">处理 Level-2 行情数据实例</a></div></div></li><li role="treeitem"><div data-tocid="金融-poc-用户历史数据导入指导手册之股票-level-2-逐笔篇-d9529e100199" class="topicref" data-id="金融-poc-用户历史数据导入指导手册之股票-level-2-逐笔篇" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/LoadDataForPoc.html" id="金融-poc-用户历史数据导入指导手册之股票-level-2-逐笔篇-d9529e100199-link">金融 PoC 用户历史数据导入指导手册之股票 Level-2 逐笔篇</a></div></div></li><li role="treeitem"><div data-tocid="多数据源流式实时关联处理-d9529e100245" class="topicref" data-id="多数据源流式实时关联处理" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/streaming-real-time-correlation-processing_2.html" id="多数据源流式实时关联处理-d9529e100245-link">多数据源流式实时关联处理</a></div></div></li><li role="treeitem"><div data-tocid="实时计算涨幅榜-d9529e100291" class="topicref" data-id="实时计算涨幅榜" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/rt_stk_price_inc_calc_2.html" id="实时计算涨幅榜-d9529e100291-link">实时计算涨幅榜</a></div></div></li><li role="treeitem"><div data-tocid="python-parser-在金融量化分析场景的应用入门-d9529e100337" class="topicref" data-id="python-parser-在金融量化分析场景的应用入门" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/py_parser__quant_fin.html" id="python-parser-在金融量化分析场景的应用入门-d9529e100337-link">Python Parser 在金融量化分析场景的应用入门</a></div></div></li><li role="treeitem"><div data-tocid="存储金融数据的分区方案最佳实践-d9529e100383" class="topicref" data-id="存储金融数据的分区方案最佳实践" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/best_practices_for_partitioned_storage.html" id="存储金融数据的分区方案最佳实践-d9529e100383-link">存储金融数据的分区方案最佳实践</a></div></div></li><li role="treeitem"><div data-tocid="实时选取外汇行情多价源最优价-d9529e100429" class="topicref" data-id="实时选取外汇行情多价源最优价" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/best_price_selection.html" id="实时选取外汇行情多价源最优价-d9529e100429-link">实时选取外汇行情多价源最优价</a></div></div></li><li role="treeitem"><div data-tocid="dolphindb-insight-行情插件最佳实践指南-d9529e100475" class="topicref" data-id="dolphindb-insight-行情插件最佳实践指南" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/insight_plugin.html" id="dolphindb-insight-行情插件最佳实践指南-d9529e100475-link">DolphinDB INSIGHT 行情插件最佳实践指南</a></div></div></li><li role="treeitem"><div data-tocid="dolphindb-xtp-插件最佳实践-d9529e100521" class="topicref" data-id="dolphindb-xtp-插件最佳实践" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/xtp.html" id="dolphindb-xtp-插件最佳实践-d9529e100521-link">DolphinDB XTP 插件最佳实践</a></div></div></li><li role="treeitem"><div data-tocid="dolphindb-教程概率统计分析-d9529e100567" class="topicref" data-id="dolphindb-教程概率统计分析" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/probabilistic_and_statistical_analysis.html" id="dolphindb-教程概率统计分析-d9529e100567-link">DolphinDB 教程：概率统计分析</a></div></div></li><li role="treeitem"><div data-tocid="基于快照行情的股票和基金-k-线合成-d9529e100613" class="topicref" data-id="基于快照行情的股票和基金-k-线合成" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/k.html" id="基于快照行情的股票和基金-k-线合成-d9529e100613-link">基于快照行情的股票和基金 K 线合成</a></div></div></li><li role="treeitem"><div data-tocid="alphalens-在-dolphindb-中的应用因子分析建模实践-d9529e100660" class="topicref" data-id="alphalens-在-dolphindb-中的应用因子分析建模实践" data-state="leaf"><span role="button" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/Practical_Factor_Analysis_Modeling.html" id="alphalens-在-dolphindb-中的应用因子分析建模实践-d9529e100660-link">Alphalens 在 DolphinDB 中的应用：因子分析建模实践</a></div></div></li></ul></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e100707" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e100707-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/iot_examples.html" id="tocId-d9529e100707-link">物联网场景案例</a></div></div></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e101629" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e101629-link" class="wh-expand-btn"></span><div class="title"><a href="../tutorials/cluster_scaleout_perf_test.html" id="tocId-d9529e101629-link">测试报告</a></div></div></li></ul></li><li role="treeitem" aria-expanded="false"><div data-tocid="tocId-d9529e101769" class="topicref" data-state="not-ready"><span role="button" tabindex="0" aria-labelledby="button-expand-action tocId-d9529e101769-link" class="wh-expand-btn"></span><div class="title"><a href="../rn/server/3_00_1.html" id="tocId-d9529e101769-link">版本说明</a><div class="wh-tooltip"><p class="shortdesc">DolphinDB 版本发布历史</p></div></div></div></li></ul></div>
		                        
                            </div>
                        </nav>
                    
                    
                    <div class="col-lg-7 col-md-9 col-sm-12" id="wh_topic_body">
                        <button id="wh_close_publication_toc_button" class="close-toc-button d-none" aria-label="Toggle publishing table of content" aria-controls="wh_publication_toc" aria-expanded="true">
                            <span class="close-toc-icon-container">
                                <span class="close-toc-icon"></span>     
                            </span>
                        </button>
                        <button id="wh_close_topic_toc_button" class="close-toc-button d-none" aria-label="Toggle topic table of content" aria-controls="wh_topic_toc" aria-expanded="true">
                            <span class="close-toc-icon-container">
                                <span class="close-toc-icon"></span>     
                            </span>
                        </button>
                        
                        <div class=" wh_topic_content body "><main role="main"><article class="- topic/topic topic" role="article" aria-labelledby="ariaid-title1"><h1 class="- topic/title title topictitle1" id="ariaid-title1">深度不平衡、买卖压力指标、波动率计算</h1><div class="- topic/body body"><p class="- topic/p p">在金融行业的数据分析工作中，数据预处理及特征工程的质量往往决定了数学模型的实际效果。某些金融指标涉及原始大量数据中高维多列的复杂运算，这将耗费大量的计算资源和开发时间。本案例基于证券交易的 level2 快照数据，开发了 10 分钟频率的深度不平衡、买卖压力指标和波动率的计算脚本，旨在为 DolphinDB 使用者在开发其他类似因子计算脚本时提供参考范例，提高开发效率。</p><p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">优化前后计算效率</strong></p><ul class="- topic/ul ul"><li class="- topic/li li">分布式表数据总量：2,874,861,174</li><li class="- topic/li li">上证 50 指数的成分股数据量：58,257,708</li><li class="- topic/li li">处理后的结果表数据量：267,490</li></ul><div class="table-container"><table class="- topic/table table" data-cols="5"><caption></caption><colgroup><col/><col/><col/><col/><col/></colgroup><thead class="- topic/thead thead"><tr class="- topic/row"><th class="- topic/entry entry colsep-0 rowsep-0" id="深度不平衡买卖压力指标波动率计算__entry__1">存储引擎</th><th class="- topic/entry entry colsep-0 rowsep-0" id="深度不平衡买卖压力指标波动率计算__entry__2">十档买卖量价存储方式</th><th class="- topic/entry entry colsep-0 rowsep-0" id="深度不平衡买卖压力指标波动率计算__entry__3">计算对象</th><th class="- topic/entry entry colsep-0 rowsep-0" id="深度不平衡买卖压力指标波动率计算__entry__4">逻辑 CPU 核数</th><th class="- topic/entry entry colsep-0 rowsep-0" id="深度不平衡买卖压力指标波动率计算__entry__5">计算耗时（s）</th></tr></thead><tbody class="- topic/tbody tbody"><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__1">OLAP</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__2">40 列</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__3">列为单位</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__4">8</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__5">450</td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__1">OLAP</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__2">40 列</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__3">矩阵</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__4">8</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__5">450</td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__1">TSDB</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__2">40 列</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__3">矩阵</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__4">8</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__5">27</td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__1">TSDB</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__2">4 列（array vector）</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__3">矩阵</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__4">8</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="深度不平衡买卖压力指标波动率计算__entry__5">25</td></tr></tbody></table></div><p class="- topic/p p">本教程包含内容：</p></div><article class="- topic/topic topic nested1" aria-labelledby="ariaid-title2" id="1-snapshot-数据文件结构"><h2 class="- topic/title title topictitle2" id="ariaid-title2">1. Snapshot 数据文件结构</h2><div class="- topic/body body"><div class="table-container"><table class="- topic/table table" data-cols="6"><caption></caption><colgroup><col/><col/><col/><col/><col/><col/></colgroup><thead class="- topic/thead thead"><tr class="- topic/row"><th class="- topic/entry entry colsep-0 rowsep-0" id="1-snapshot-数据文件结构__entry__1">字段</th><th class="- topic/entry entry colsep-0 rowsep-0" id="1-snapshot-数据文件结构__entry__2">含义</th><th class="- topic/entry entry colsep-0 rowsep-0" id="1-snapshot-数据文件结构__entry__3">字段</th><th class="- topic/entry entry colsep-0 rowsep-0" id="1-snapshot-数据文件结构__entry__4">含义</th><th class="- topic/entry entry colsep-0 rowsep-0" id="1-snapshot-数据文件结构__entry__5">字段</th><th class="- topic/entry entry colsep-0 rowsep-0" id="1-snapshot-数据文件结构__entry__6">含义</th></tr></thead><tbody class="- topic/tbody tbody"><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__1">SecurityID</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__2">证券代码</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__3">LowPx</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__4">最低价</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__5">BidPrice[10]</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__6">申买十价</td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__1">DateTime</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__2">日期时间</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__3">LastPx</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__4">最新价</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__5">BidOrderQty[10]</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__6">申买十量</td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__1">PreClosePx</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__2">昨收价</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__3">TotalVolumeTrade</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__4">成交总量</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__5">OfferPrice[10]</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__6">申卖十价</td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__1">OpenPx</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__2">开始价</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__3">TotalValueTrade</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__4">成交总金额</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__5">OfferOrderQty[10]</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__6">申卖十量</td></tr><tr class="- topic/row"><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__1">HighPx</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__2">最高价</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__3">InstrumentStatus</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__4">交易状态</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__5">……</td><td class="- topic/entry entry colsep-0 rowsep-0" headers="1-snapshot-数据文件结构__entry__6">……</td></tr></tbody></table></div><p class="- topic/p p">本案例用到的字段为 Snapshot 中的部分字段，包括：股票代码、快照时间、申买十价，申买十量，申卖十价，申卖十量。</p><p class="- topic/p p">样本为 2020 年上证 50 指数的成分股：</p><ul class="- topic/ul ul"><li class="- topic/li li"><p class="- topic/p p">股票代码</p><pre class="+ topic/pre pr-d/codeblock pre codeblock tex"><code>601318,600519,600036,600276,601166,600030,600887,600016,601328,601288,
600000,600585,601398,600031,601668,600048,601888,600837,601601,601012,
603259,601688,600309,601988,601211,600009,600104,600690,601818,600703,
600028,601088,600050,601628,601857,601186,600547,601989,601336,600196,
603993,601138,601066,601236,601319,603160,600588,601816,601658,600745</code></pre></li><li class="- topic/li li"><p class="- topic/p p">股票名称</p><pre class="+ topic/pre pr-d/codeblock pre codeblock tex"><code>中国平安、贵州茅台、招商银行、恒瑞医药、兴业银行、中信证券、伊利股份、民生银行、交通银行、农业银行、
浦发银行、海螺水泥、工商银行、三一重工、中国建筑、保利地产、中国中免、海通证券、中国太保、隆基股份、
药明康德、华泰证券、万华化学、中国银行、国泰君安、上海机场、上汽集团、海尔智家、光大银行、三安光电、
中国石化、中国神华、中国联通、中国人寿、中国石油、中国铁建、山东黄金、中国重工、新华保险、复星医药、
洛阳钼业、工业富联、中信建投、红塔证券、中国人保、汇顶科技、用友网络、京沪高铁、邮储银行、闻泰科技</code></pre></li></ul><p class="- topic/p p">2020 年上交所 14460 个证券的 Snapshot 数据已经提前导入至 DolphinDB 数据库中，一共约 28.75 亿条快照数据，导入方法见<a class="- topic/xref xref" href="stockdata_csv_import_demo.html">股票行情数据导入实例</a>，一共 174 列。</p></div></article><article class="- topic/topic topic nested1" aria-labelledby="ariaid-title3" id="2-指标定义"><h2 class="- topic/title title topictitle2" id="ariaid-title3">2. 指标定义</h2><div class="- topic/body body"><ul class="- topic/ul ul"><li class="- topic/li li"><p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">Weighted Averaged Price(WAP)</strong>：加权平均价格</p><img class="- topic/image image" src="images/sql_performance_optimization_wap_di_rv/wap.png"/><br/></li><li class="- topic/li li"><p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">Depth Imbalance(DI)</strong>：深度不平衡</p><img class="- topic/image image" src="images/sql_performance_optimization_wap_di_rv/dij.png"/><br/></li><li class="- topic/li li"><p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">Press</strong>：买卖压力指标</p><img class="- topic/image image" src="images/sql_performance_optimization_wap_di_rv/wi.png"/><br/></li></ul><p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">特征数据重采样（10min 窗口，并聚合计算波动率）</strong></p><p class="- topic/p p">重采样利用<code class="+ topic/ph pr-d/codeph ph codeph">group by SecurityID, interval( TradeTime, 10m, "none" )</code>方法</p><ul class="- topic/ul ul"><li class="- topic/li li"><p class="- topic/p p"><strong class="+ topic/ph hi-d/b ph b">Realized Volatility(RV)</strong>：波动率定义为对数收益率的平方和的平方根</p><img class="- topic/image image" src="images/sql_performance_optimization_wap_di_rv/rv.png"/><br/></li></ul><p class="- topic/p p">股票的价格始终是处于买单价和卖单价之间，因此本项目用加权平均价格来代替股价进行计算</p><img class="- topic/image image" src="images/sql_performance_optimization_wap_di_rv/rt1t2.png"/><br/></div></article><article class="- topic/topic topic nested1" aria-labelledby="ariaid-title4" id="3-sql-优化"><h2 class="- topic/title title topictitle2" id="ariaid-title4">3. SQL 优化</h2><div class="- topic/body body"><p class="- topic/p p">这些指标的计算 SQL 语句由以下几部分组成：</p><pre class="+ topic/pre pr-d/codeblock pre codeblock"><code>SELECT 指标计算函数(参数)
FROM 数据源
WHERE 日期筛选条件,股票筛选条件,交易时间筛选条件
GROUP BY 股票代码, interval(时间列,时间单位,缺失值填充方式)</code></pre><p class="- topic/p p">本教程的优化部分为指标计算函数的处理过程。</p></div><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title5" id="31-新手以列为单位进行计算"><h3 class="- topic/title title topictitle3" id="ariaid-title5">3.1. 新手：以列为单位进行计算</h3><div class="- topic/body body"><p class="- topic/p p">数据采用 OLAP 存储引擎存储。</p><p class="- topic/p p">根据指标定义公式，以列为单位进行计算，开发者能够快速写出以下 SQL 代码：</p><pre class="+ topic/pre pr-d/codeblock pre codeblock"><code>/**
part1: Define calculation function
*/
def calPress(BidPrice0,BidPrice1,BidPrice2,BidPrice3,BidPrice4,BidPrice5,BidPrice6,BidPrice7,BidPrice8,BidPrice9,BidOrderQty0,BidOrderQty1,BidOrderQty2,BidOrderQty3,BidOrderQty4,BidOrderQty5,BidOrderQty6,BidOrderQty7,BidOrderQty8,BidOrderQty9,OfferPrice0,OfferPrice1,OfferPrice2,OfferPrice3,OfferPrice4,OfferPrice5,OfferPrice6,OfferPrice7,OfferPrice8,OfferPrice9,OfferOrderQty0,OfferOrderQty1,OfferOrderQty2,OfferOrderQty3,OfferOrderQty4,OfferOrderQty5,OfferOrderQty6,OfferOrderQty7,OfferOrderQty8,OfferOrderQty9){
 WAP = (BidPrice0*OfferOrderQty0+OfferPrice0*BidOrderQty0)\(BidOrderQty0+OfferOrderQty0)
 Bid_1_P_WAP_SUM = 1\(BidPrice0-WAP) + 1\(BidPrice1-WAP) + 1\(BidPrice2-WAP) + 1\(BidPrice3-WAP) + 1\(BidPrice4-WAP) + 1\(BidPrice5-WAP) + 1\(BidPrice6-WAP) + 1\(BidPrice7-WAP) + 1\(BidPrice8-WAP) + 1\(BidPrice9-WAP)
 Offer_1_P_WAP_SUM = 1\(OfferPrice0-WAP)+1\(OfferPrice1-WAP)+1\(OfferPrice2-WAP)+1\(OfferPrice3-WAP)+1\(OfferPrice4-WAP)+1\(OfferPrice5-WAP)+1\(OfferPrice6-WAP)+1\(OfferPrice7-WAP)+1\(OfferPrice8-WAP)+1\(OfferPrice9-WAP)
 BidPress = BidOrderQty0*((1\(BidPrice0-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty1*((1\(BidPrice1-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty2*((1\(BidPrice2-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty3*((1\(BidPrice3-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty4*((1\(BidPrice4-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty5*((1\(BidPrice5-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty6*((1\(BidPrice6-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty7*((1\(BidPrice7-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty8*((1\(BidPrice8-WAP))\Bid_1_P_WAP_SUM) + BidOrderQty9*((1\(BidPrice9-WAP))\Bid_1_P_WAP_SUM)
 OfferPress = OfferOrderQty0*((1\(OfferPrice0-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty1*((1\(OfferPrice1-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty2*((1\(OfferPrice2-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty3*((1\(OfferPrice3-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty4*((1\(OfferPrice4-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty5*((1\(OfferPrice5-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty6*((1\(OfferPrice6-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty7*((1\(OfferPrice7-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty8*((1\(OfferPrice8-WAP))\Offer_1_P_WAP_SUM) + OfferOrderQty9*((1\(OfferPrice9-WAP))\Offer_1_P_WAP_SUM)
 return log(BidPress)-log(OfferPress)
}

/**
part2: Define variables and assign values
*/
stockList=`601318`600519`600036`600276`601166`600030`600887`600016`601328`601288`600000`600585`601398`600031`601668`600048`601888`600837`601601`601012`603259`601688`600309`601988`601211`600009`600104`600690`601818`600703`600028`601088`600050`601628`601857`601186`600547`601989`601336`600196`603993`601138`601066`601236`601319`603160`600588`601816`601658`600745
dbName = "dfs://snapshot_SH_L2_OLAP"
tableName = "snapshot_SH_L2_OLAP"
snapshot = loadTable(dbName, tableName)

/**
part3: Execute SQL
*/
result = select
            avg((OfferPrice0\BidPrice0-1)) as BAS,
            avg((BidOrderQty0-OfferOrderQty0)\(BidOrderQty0+OfferOrderQty0)) as DI0,
            avg((BidOrderQty1-OfferOrderQty1)\(BidOrderQty1+OfferOrderQty1)) as DI1,
            avg((BidOrderQty2-OfferOrderQty2)\(BidOrderQty2+OfferOrderQty2)) as DI2,
            avg((BidOrderQty3-OfferOrderQty3)\(BidOrderQty3+OfferOrderQty3)) as DI3,
            avg((BidOrderQty4-OfferOrderQty4)\(BidOrderQty4+OfferOrderQty4)) as DI4,
            avg((BidOrderQty5-OfferOrderQty5)\(BidOrderQty5+OfferOrderQty5)) as DI5,
            avg((BidOrderQty6-OfferOrderQty6)\(BidOrderQty6+OfferOrderQty6)) as DI6,
            avg((BidOrderQty7-OfferOrderQty7)\(BidOrderQty7+OfferOrderQty7)) as DI7,
            avg((BidOrderQty8-OfferOrderQty8)\(BidOrderQty8+OfferOrderQty8)) as DI8,
            avg((BidOrderQty9-OfferOrderQty9)\(BidOrderQty9+OfferOrderQty9)) as DI9,
            avg(calPress(BidPrice0,BidPrice1,BidPrice2,BidPrice3,BidPrice4,BidPrice5,BidPrice6,BidPrice7,BidPrice8,BidPrice9, BidOrderQty0,BidOrderQty1,BidOrderQty2,BidOrderQty3,BidOrderQty4,BidOrderQty5,BidOrderQty6,BidOrderQty7,BidOrderQty8,BidOrderQty9,OfferPrice0,OfferPrice1,OfferPrice2,OfferPrice3,OfferPrice4,OfferPrice5,OfferPrice6,OfferPrice7,OfferPrice8,OfferPrice9,OfferOrderQty0,OfferOrderQty1,OfferOrderQty2,OfferOrderQty3,OfferOrderQty4,OfferOrderQty5,OfferOrderQty6,OfferOrderQty7,OfferOrderQty8,OfferOrderQty9)) as Press,
            sqrt(sum(pow((log((BidPrice0*OfferOrderQty0+OfferPrice0*BidOrderQty0)\(BidOrderQty0+OfferOrderQty0))-prev(log((BidPrice0*OfferOrderQty0+OfferPrice0*BidOrderQty0)\(BidOrderQty0+OfferOrderQty0)))),2))) as RV
  from snapshot
  where date(TradeTime) between 2020.01.01 : 2020.12.31, SecurityID in stockList, (time(TradeTime) between 09:30:00.000 : 11:29:59.999) || (time(TradeTime) between 13:00:00.000 : 14:56:59.999)
  group by SecurityID, interval( TradeTime, 10m, "none" ) as TradeTime</code></pre><p class="- topic/p p">上述 SQL 中，涉及<code class="+ topic/ph pr-d/codeph ph codeph">BidPrice0-9</code>、<code class="+ topic/ph pr-d/codeph ph codeph">BidOrderQty0-9</code>、<code class="+ topic/ph pr-d/codeph ph codeph">OfferPrice0-9</code>、<code class="+ topic/ph pr-d/codeph ph codeph">OfferOrderQty0-9</code>共 40 列数据，且由于指标定义较为复杂，即使公式化简后，仍然难以解决代码冗长、修改困难的问题。</p><p class="- topic/p p">计算处理效率：</p><ul class="- topic/ul ul"><li class="- topic/li li">分布式表数据总量：2,874,861,174</li><li class="- topic/li li">上证 50 指数的成分股数据量：58,257,708</li><li class="- topic/li li">逻辑 CPU 核数：8</li><li class="- topic/li li">平均占用 CPU 核心数：4.5 个</li><li class="- topic/li li">耗时：450 秒</li></ul></div></article><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title6" id="32-进阶将列拼接为矩阵进行计算"><h3 class="- topic/title title topictitle3" id="ariaid-title6">3.2. 进阶：将列拼接为矩阵进行计算</h3><div class="- topic/body body"><p class="- topic/p p">数据采用 OLAP 存储引擎存储。</p><p class="- topic/p p">上述公式定义中都是列与列之间的计算，实际计算往往发生在<code class="+ topic/ph pr-d/codeph ph codeph">BidPrice</code>，<code class="+ topic/ph pr-d/codeph ph codeph">BidOrderQty</code>，<code class="+ topic/ph pr-d/codeph ph codeph">OfferPrice</code>，<code class="+ topic/ph pr-d/codeph ph codeph">OfferOrderQty</code>这 4 个大组之间（每组 10 列），因此可以将这四个大组看成 n 行 10 列的矩阵。在 SQL 中进行 matrix 拼接，再传入聚合函数中进行矩阵运算，示例代码如下：</p><pre class="+ topic/pre pr-d/codeblock pre codeblock"><code>/**
part1: Define calculation function
*/
defg featureEngine(bidPrice,bidQty,offerPrice,offerQty){
 bas = offerPrice[0]\bidPrice[0]-1
 wap = (bidPrice[0]*offerQty[0] + offerPrice[0]*bidQty[0])\(bidQty[0]+offerQty[0])
 di = (bidQty-offerQty)\(bidQty+offerQty)
 bidw=(1.0\(bidPrice-wap))
 bidw=bidw\(bidw.rowSum())
 offerw=(1.0\(offerPrice-wap))
 offerw=offerw\(offerw.rowSum())
 press=log((bidQty*bidw).rowSum())-log((offerQty*offerw).rowSum())
 rv=sqrt(sum2(log(wap)-log(prev(wap))))
 return avg(bas),avg(di[0]),avg(di[1]),avg(di[2]),avg(di[3]),avg(di[4]),avg(di[5]),avg(di[6]),avg(di[7]),avg(di[8]),avg(di[9]),avg(press),rv
}

/**
part2: Define variables and assign values
*/
stockList=`601318`600519`600036`600276`601166`600030`600887`600016`601328`601288`600000`600585`601398`600031`601668`600048`601888`600837`601601`601012`603259`601688`600309`601988`601211`600009`600104`600690`601818`600703`600028`601088`600050`601628`601857`601186`600547`601989`601336`600196`603993`601138`601066`601236`601319`603160`600588`601816`601658`600745
dbName = "dfs://snapshot_SH_L2_OLAP"
tableName = "snapshot_SH_L2_OLAP"
snapshot = loadTable(dbName, tableName)

/**
part3: Execute SQL
*/
result1 = select
            featureEngine(
            matrix(BidPrice0,BidPrice1,BidPrice2,BidPrice3,BidPrice4,BidPrice5,BidPrice6,BidPrice7,BidPrice8,BidPrice9),
            matrix(BidOrderQty0,BidOrderQty1,BidOrderQty2,BidOrderQty3,BidOrderQty4,BidOrderQty5,BidOrderQty6,BidOrderQty7, BidOrderQty8,BidOrderQty9),
            matrix(OfferPrice0,OfferPrice1,OfferPrice2,OfferPrice3,OfferPrice4,OfferPrice5,OfferPrice6,OfferPrice7,OfferPrice8, OfferPrice9),
            matrix(OfferOrderQty0,OfferOrderQty1,OfferOrderQty2,OfferOrderQty3,OfferOrderQty4,OfferOrderQty5,OfferOrderQty6, OfferOrderQty7,OfferOrderQty8,OfferOrderQty9)) as `BAS`DI0`DI1`DI2`DI3`DI4`DI5`DI6`DI7`DI8`DI9`Press`RV
  from snapshot
  where date(TradeTime) between 2020.01.01 : 2020.12.31, SecurityID in stockList, (time(TradeTime) between 09:30:00.000 : 11:29:59.999) || (time(TradeTime) between 13:00:00.000 : 14:56:59.999)
  group by SecurityID, interval( TradeTime, 10m, "none" ) as TradeTime map</code></pre><p class="- topic/p p">通过矩阵化处理，代码大量减少，且在自定义聚合函数中已经可以比较容易的看出指标公式的计算代码，这将极大地方便后续公式定义和指标计算代码的修改。</p><p class="- topic/p p">计算处理效率：</p><ul class="- topic/ul ul"><li class="- topic/li li">分布式表数据总量：2,874,861,174</li><li class="- topic/li li">上证 50 指数的成分股数据量：58,257,708</li><li class="- topic/li li">逻辑 CPU 核数：8</li><li class="- topic/li li">平均占用 CPU 核心数：4.5 个</li><li class="- topic/li li">耗时：450 秒</li></ul></div></article><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title7" id="33-高性能-1tsdb-存储和计算"><h3 class="- topic/title title topictitle3" id="ariaid-title7">3.3. 高性能 1：TSDB 存储和计算</h3><div class="- topic/body body"><p class="- topic/p p">DolphinDB v2.00 新增了 TSDB 存储引擎，在创建分区数据库和表时与 OLAP 存储引擎的不同之处是必须指定 <code class="+ topic/ph pr-d/codeph ph codeph">engine</code> 和 <code class="+ topic/ph pr-d/codeph ph codeph">sortColumns</code>，创建语句如下：</p><pre class="+ topic/pre pr-d/codeblock pre codeblock"><code>dbName = "dfs://snapshot_SH_L2_TSDB"
tableName = "snapshot_SH_L2_TSDB"
dbTime = database(, VALUE, 2020.01.01..2020.12.31)
dbSymbol = database(, HASH, [SYMBOL, 20])
db = database(dbName, COMPO, [dbTime, dbSymbol], engine='TSDB')
createPartitionedTable(dbHandle=db, table=tbTemp, tableName=tableName, partitionColumns=`TradeTime`SecurityID, sortColumns=`SecurityID`TradeTime)</code></pre><p class="- topic/p p">计算代码与前述进阶代码完全相同。</p><p class="- topic/p p">由于 TSDB 存储引擎的查询优化，数据计算性能得到了极大地提升。原来需要运行 450 秒完成的计算，优化后只需运行 27 秒，计算速度是未优化代码的 17 倍。</p><p class="- topic/p p">计算处理效率：</p><ul class="- topic/ul ul"><li class="- topic/li li">分布式表数据总量：2,874,861,174</li><li class="- topic/li li">上证 50 指数的成分股数据量：58,257,708</li><li class="- topic/li li">逻辑 CPU 核数：8</li><li class="- topic/li li">平均占用 CPU 核心数：7.6 个</li><li class="- topic/li li">无 level file 索引缓存下的计算耗时：27 秒</li><li class="- topic/li li">有 level file 索引缓存下的计算耗时：16 秒</li></ul></div></article><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title8" id="34-高性能-2在-tsdb-中使用数组向量存储和计算"><h3 class="- topic/title title topictitle3" id="ariaid-title8">3.4. 高性能 2：在 TSDB 中使用数组向量存储和计算</h3><div class="- topic/body body"><p class="- topic/p p">DolphinDB 从 v2.00.4 开始，分布式表的存储支持数组向量 <code class="+ topic/ph pr-d/codeph ph codeph">array vector</code>，因此在数据存储时可以把<code class="+ topic/ph pr-d/codeph ph codeph">BidPrice0-9</code>、<code class="+ topic/ph pr-d/codeph ph codeph">BidOrderQty0-9</code>、<code class="+ topic/ph pr-d/codeph ph codeph">OfferPrice0-9</code>、<code class="+ topic/ph pr-d/codeph ph codeph">OfferOrderQty0-9</code>共 40 列数据以 array vector 形式存储为<code class="+ topic/ph pr-d/codeph ph codeph">BidPrice</code>、<code class="+ topic/ph pr-d/codeph ph codeph">BidOrderQty</code>、<code class="+ topic/ph pr-d/codeph ph codeph">OfferPrice</code>、<code class="+ topic/ph pr-d/codeph ph codeph">OfferOrderQty</code>4 列，SQL 的示例代码如下：</p><pre class="+ topic/pre pr-d/codeblock pre codeblock"><code>/**
part1: Define calculation function
*/
defg featureEngine(bidPrice,bidQty,offerPrice,offerQty){
 bas = offerPrice[0]\bidPrice[0]-1
 wap = (bidPrice[0]*offerQty[0] + offerPrice[0]*bidQty[0])\(bidQty[0]+offerQty[0])
 di = (bidQty-offerQty)\(bidQty+offerQty)
 bidw=(1.0\(bidPrice-wap))
 bidw=bidw\(bidw.rowSum())
 offerw=(1.0\(offerPrice-wap))
 offerw=offerw\(offerw.rowSum())
 press=log((bidQty*bidw).rowSum())-log((offerQty*offerw).rowSum())
 rv=sqrt(sum2(log(wap)-log(prev(wap))))
 return avg(bas),avg(di[0]),avg(di[1]),avg(di[2]),avg(di[3]),avg(di[4]),avg(di[5]),avg(di[6]),avg(di[7]),avg(di[8]),avg(di[9]),avg(press),rv
}

/**
part2: Define variables and assign values
*/
stockList=`601318`600519`600036`600276`601166`600030`600887`600016`601328`601288`600000`600585`601398`600031`601668`600048`601888`600837`601601`601012`603259`601688`600309`601988`601211`600009`600104`600690`601818`600703`600028`601088`600050`601628`601857`601186`600547`601989`601336`600196`603993`601138`601066`601236`601319`603160`600588`601816`601658`600745
dbName = "dfs://snapshot_SH_L2_TSDB_ArrayVector"
tableName = "snapshot_SH_L2_TSDB_ArrayVector"
snapshot = loadTable(dbName, tableName)

/**
part3: Execute SQL
*/
result = select
  featureEngine(BidPrice,BidOrderQty,OfferPrice,OfferOrderQty) as `BAS`DI0`DI1`DI2`DI3`DI4`DI5`DI6`DI7`DI8`DI9`Press`RV
  from snapshot
  where date(TradeTime) between 2020.01.01 : 2020.12.31, SecurityID in stockList, (time(TradeTime) between 09:30:00.000 : 11:29:59.999) || (time(TradeTime) between 13:00:00.000 : 14:56:59.999)
  group by SecurityID, interval( TradeTime, 10m, "none" ) as TradeTime map</code></pre><p class="- topic/p p">使用 TSDB 的 array vector 进行数据存储，在性能上相较于 TSDB 的分列存储提升不明显，但是代码更加精简，方便后期的修改和维护。</p><p class="- topic/p p">计算效率：</p><ul class="- topic/ul ul"><li class="- topic/li li">分布式表数据总量：2,874,861,174</li><li class="- topic/li li">上证 50 指数的成分股数据量：58,257,708</li><li class="- topic/li li">逻辑 CPU 核数：8</li><li class="- topic/li li">平均占用 CPU 核心数：7.6 个</li><li class="- topic/li li">无 level file 索引缓存下的计算耗时：25 秒</li><li class="- topic/li li">有 level file 索引缓存下的计算耗时：15 秒</li></ul></div></article></article><article class="- topic/topic topic nested1" aria-labelledby="ariaid-title9" id="4-olap-到-tsdb-的性能提升原因"><h2 class="- topic/title title topictitle2" id="ariaid-title9">4. OLAP 到 TSDB 的性能提升原因</h2><div class="- topic/body body"></div><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title10" id="41-数据库分区方法"><h3 class="- topic/title title topictitle3" id="ariaid-title10">4.1. 数据库分区方法</h3><div class="- topic/body body"><p class="- topic/p p">OLAP 存储引擎创建分区数据库的代码：</p><pre class="+ topic/pre pr-d/codeblock pre codeblock"><code>dbName = "dfs://snapshot_SH_L2_OLAP"
dbTime = database(, VALUE, 2020.01.01..2020.12.31)
dbSymbol = database(, HASH, [SYMBOL, 20])
db = database(dbName, COMPO, [dbTime, dbSymbol])</code></pre><p class="- topic/p p">TSDB 存储引擎创建分区数据库的代码：</p><pre class="+ topic/pre pr-d/codeblock pre codeblock"><code>dbName = "dfs://snapshot_SH_L2_TSDB"
dbTime = database(, VALUE, 2020.01.01..2020.12.31)
dbSymbol = database(, HASH, [SYMBOL, 20])
db = database(dbName, COMPO, [dbTime, dbSymbol], engine='TSDB')</code></pre><p class="- topic/p p">DolphinDB 的分区规则是建立在数据库层面上的，本案例中，OLAP 存储引擎和 TSDB 存储引擎的分区规则相同，第一层按天分区，第二层以证券代码采用哈希算法分 20 个区。因此，14460 个证券每天的数据被相对均匀地存储在 20 个分区内，上证 50 指数成分股的数据也被分散存储在多个分区内；从另一个角度理解，同一个分区内包含多个哈希值相同的证券的数据。</p><p class="- topic/p p">在 DolphinDB 中，无论是 OLAP 存储引擎还是 TSDB 存储引擎，数据的切片思想和算法是一致的，所以本案例中，数据库创建代码中唯一的差异是，TSDB 存储引擎需要指定参数<code class="+ topic/ph pr-d/codeph ph codeph">engine</code>为<code class="+ topic/ph pr-d/codeph ph codeph">TSDB</code>，该参数默认值是<code class="+ topic/ph pr-d/codeph ph codeph">OLAP</code>。</p></div></article><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title11" id="42-数据表创建方法"><h3 class="- topic/title title topictitle3" id="ariaid-title11">4.2. 数据表创建方法</h3><div class="- topic/body body"><p class="- topic/p p">OLAP 存储引擎创建分区数据表的代码：</p><pre class="+ topic/pre pr-d/codeblock pre codeblock"><code>dbName = "dfs://snapshot_SH_L2_OLAP"
db = database(dbName)
tableName = "snapshot_SH_L2_OLAP"
createPartitionedTable(dbHandle=db, table=tbTemp, tableName=tbName, partitionColumns=`TradeTime`SecurityID)</code></pre><p class="- topic/p p">TSDB 存储引擎创建分区数据表的代码：</p><pre class="+ topic/pre pr-d/codeblock pre codeblock"><code>dbName = "dfs://snapshot_SH_L2_TSDB"
db = database(dbName)
tableName = "snapshot_SH_L2_TSDB"
createPartitionedTable(dbHandle=db, table=tbTemp, tableName=tableName, partitionColumns=`TradeTime`SecurityID, sortColumns=`SecurityID`TradeTime)</code></pre><p class="- topic/p p">在使用 TSDB 存储引擎创建分区数据表时，设置了<code class="+ topic/ph pr-d/codeph ph codeph">sortColumns=</code>SecurityID<code class="+ topic/ph pr-d/codeph ph codeph">TradeTime</code>，<code class="+ topic/ph pr-d/codeph ph codeph">sortColumns</code>一般由两部分组成：</p><ul class="- topic/ul ul"><li class="- topic/li li"><code class="+ topic/ph pr-d/codeph ph codeph">sortKey</code>：可以由一个或多个查询索引列组成，不包含数据的时间列</li><li class="- topic/li li">时间列：数据中的时间列，作为分区内数据按时间顺序的排序列</li></ul><p class="- topic/p p">本案例中，<code class="+ topic/ph pr-d/codeph ph codeph">sortKey=</code>SecurityID<code class="+ topic/ph pr-d/codeph ph codeph">，时间列为</code>TradeTime<code class="+ topic/ph pr-d/codeph ph codeph">。与OLAP存储引擎相比，TSDB存储的每个分区中的同一</code>SecurityID<code class="+ topic/ph pr-d/codeph ph codeph">的数据在磁盘文件中是连续的，且按照</code>TradeTime<code class="+ topic/ph pr-d/codeph ph codeph">严格排序。相比于OLAP存储引擎，TSDB存储引擎在根据</code>sortColumes`字段进行数据过滤查询时，可以根据分区内的索引文件从磁盘上只加载满足过滤条件的数据。</p><p class="- topic/p p">本案例的计算样本是 2020 年上证 50 指数成分股，计算数据源是 2020 年上交所 14460 个证券的全部数据。如果采用 OLAP 存储引擎，需要将上证 50 指数成分股涉及的分区内的无关证券的数据同时从磁盘上加载到内存后，进行数据的解压、过滤和计算操作。如果采用 TSDB，只需要将上证 50 指数成分股的数据从磁盘上加载到内存，进行数据的计算操作。</p></div></article><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title12" id="43-olap-存储引擎与-tsdb-存储引擎的差异"><h3 class="- topic/title title topictitle3" id="ariaid-title12">4.3. OLAP 存储引擎与 TSDB 存储引擎的差异</h3><div class="- topic/body body"><p class="- topic/p p">OLAP 存储引擎保持了数据写入时的顺序，以一种 append-only 的方式往磁盘上存储数据。分区表的每个分区内的每个列是一个文件，对于某个列文件而言，多个<code class="+ topic/ph pr-d/codeph ph codeph">SecurityID</code>的数据是根据数据写入顺序添加到文件中的，所以同一个<code class="+ topic/ph pr-d/codeph ph codeph">SecurityID</code>的数据很大概率是散乱地分布在整个列文件的各个位置。本案例中，查询数据表存储了 14460 个证券的数据，虽然只查询上证 50 指数成分股的数据，但是在 OLAP 存储引擎下，会将上证 50 指数成分股涉及的分区内的无关证券的数据同时从磁盘上读取到内存进行解压，降低了数据提取的效率。</p><p class="- topic/p p">TSDB 存储引擎设置了<code class="+ topic/ph pr-d/codeph ph codeph">sortColumns=`SecurityID`TradeTime</code>，对同一个<code class="+ topic/ph pr-d/codeph ph codeph">SecurityID</code>的数据的存储是连续的，且存储的时候需要压缩：</p><ul class="- topic/ul ul"><li class="- topic/li li">如果将同一个<code class="+ topic/ph pr-d/codeph ph codeph">SecurityID</code>的所有数据一起压缩，那每次查询的时候，即便真正需要查询的数据只是这个<code class="+ topic/ph pr-d/codeph ph codeph">SecurityID</code>全部数据的一小部分，仍然需要将所有的数据都从磁盘读到内存中以进行解压，降低数据读取效率。</li><li class="- topic/li li">TSDB 存储引擎的做法是将同一个<code class="+ topic/ph pr-d/codeph ph codeph">SecurityID</code>在同一个 LevelFile 里的全部数据一起压缩存储，并且指定一个时间区间以供查询，而这个时间区间内的数据只占据了这个<code class="+ topic/ph pr-d/codeph ph codeph">SecurityID</code>所有数据的一小部分。在本案例中，同一个<code class="+ topic/ph pr-d/codeph ph codeph">SecurityID</code>的数据根据<code class="+ topic/ph pr-d/codeph ph codeph">sortColumns</code>最后一列<code class="+ topic/ph pr-d/codeph ph codeph">TradeTime</code>排序，并将数据拆成一定大小（默认为 16KB）的数据块（block）来存储。在读取数据的时候，TSDB 根据查询语句中的股票列和时间列过滤条件先快速定位到满足过滤条件的数据块，再将这些数据块读到内存里进行解压，而这些数据块通常只占所有数据的一小部分，这样就可以大大提升查询的效率。</li></ul><br/><img class="- topic/image image" src="images/sql_performance_optimization_wap_di_rv/levelFileBlock.png" alt="fileblocklevel"/><br/></div></article><article class="- topic/topic topic nested2" aria-labelledby="ariaid-title13" id="44-小结"><h3 class="- topic/title title topictitle3" id="ariaid-title13">4.4. 小结</h3><div class="- topic/body body"><p class="- topic/p p">本案例中，使用 TSDB 存储引擎比 OLAP 存储引擎计算性能提升的主要原因如下：</p><ul class="- topic/ul ul"><li class="- topic/li li"><p class="- topic/p p">本案例计算场景中，查询数据表中存储了上交所 2020 年所有证券的 Level-2 快照数据，14,460 个证券共 2,874,861,174 条数据。计算的样本数据为 2020 年上证 50 指数的成分股，共 58,257,708 条数据。在没有任何缓存的前提下，与 OLAP 存储引擎相比，TSDB 存储引擎仅仅只需要去磁盘上读取 58,257,708 条数据。</p></li><li class="- topic/li li"><p class="- topic/p p">DolphinDB 从 v2.00.4 开始，分布式表的存储支持数组向量（<code class="+ topic/ph pr-d/codeph ph codeph">array vector</code>），特别适用于金融快照数据多档量价数据的存储。针对上交所 level2 快照数据，采用 array vector 存储后，压缩比可以提升到 9~11。在没有任何缓存的前提下，与多列存储方案相比，采用 TSDB 的 array vector 存储后，单位时间内从磁盘上读取的数据条数提升。</p></li><li class="- topic/li li"><p class="- topic/p p">Level-2 快照数据中的多档量价数据采用 DolphinDB TSDB 存储引擎的 <code class="+ topic/ph pr-d/codeph ph codeph">array vector</code> 存储后，从某种意义上实现了数据的三维存储，即在分布式表的某列某行中存储了一个向量对象，所以在对多档量价数据做矩阵运算时，取某一列的多行数据返回的对象就是一个矩阵，与多列存储方案相比，省去了矩阵拼接的过程。</p></li></ul></div></article></article><article class="- topic/topic topic nested1" aria-labelledby="ariaid-title14" id="5-总结"><h2 class="- topic/title title topictitle2" id="ariaid-title14">5. 总结</h2><div class="- topic/body body"><p class="- topic/p p">本案例基于同一个计算场景，开发了 4 份 SQL 代码：</p><ul class="- topic/ul ul"><li class="- topic/li li"><strong class="+ topic/ph hi-d/b ph b">新手篇</strong>代码数据存储采用 DolphinDB 的 OLAP 存储引擎，基于列式计算思想，代码开发难度简单，但是存在代码冗长、修改困难的问题，计算时间为 450 秒。</li><li class="- topic/li li"><strong class="+ topic/ph hi-d/b ph b">进阶篇</strong>代码数据存储采用 DolphinDB 的 OLAP 存储引擎，基于矩阵计算思想，代码开发难度一般，代码量减少，计算逻辑表达更加清晰，计算耗时为 450 秒。</li><li class="- topic/li li"><strong class="+ topic/ph hi-d/b ph b">高性能 1 篇</strong>代码数据存储采用 DolphinDB 的 TSDB 存储引擎，基于矩阵计算思想，脚本代码与进阶篇代码完全相同，无 level file 索引缓存下计算耗时为 27 秒，有 level file 索引缓存下计算耗时为 16 秒。</li><li class="- topic/li li"><strong class="+ topic/ph hi-d/b ph b">高性能 2 篇</strong>代码数据存储采用 DolphinDB 的 TSDB 存储引擎，且多档量价数据采用<code class="+ topic/ph pr-d/codeph ph codeph">array vector</code>进行存储，基于矩阵计算思想，代码精简，方便后期的修改和维护，无 level file 索引缓存下计算耗时为 25 秒，有 level file 索引缓存下计算耗时为 15 秒。</li></ul><p class="- topic/p p">旨在为 DolphinDB 使用者在开发其他类似因子计算脚本时提供参考范例，提高开发效率。</p></div></article></article></main></div>
                        
                        
                        
                        
                        
                        
                    </div>
                    
                        <nav role="navigation" id="wh_topic_toc" aria-label="On this page" class="col-lg-2 d-none d-lg-block navbar d-print-none"> 
                            <div id="wh_topic_toc_content">
		                        
	                            <div class=" wh_topic_toc "><div class="wh_topic_label">在本页上</div><ul><li class="topic-item"><a href="#1-snapshot-%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84" data-tocid="1-snapshot-数据文件结构">1. Snapshot 数据文件结构</a></li><li class="topic-item"><a href="#2-%E6%8C%87%E6%A0%87%E5%AE%9A%E4%B9%89" data-tocid="2-指标定义">2. 指标定义</a></li><li class="topic-item"><a href="#3-sql-%E4%BC%98%E5%8C%96" data-tocid="3-sql-优化">3. SQL 优化</a><ul><li class="topic-item"><a href="#31-%E6%96%B0%E6%89%8B%E4%BB%A5%E5%88%97%E4%B8%BA%E5%8D%95%E4%BD%8D%E8%BF%9B%E8%A1%8C%E8%AE%A1%E7%AE%97" data-tocid="31-新手以列为单位进行计算">3.1. 新手：以列为单位进行计算</a></li><li class="topic-item"><a href="#32-%E8%BF%9B%E9%98%B6%E5%B0%86%E5%88%97%E6%8B%BC%E6%8E%A5%E4%B8%BA%E7%9F%A9%E9%98%B5%E8%BF%9B%E8%A1%8C%E8%AE%A1%E7%AE%97" data-tocid="32-进阶将列拼接为矩阵进行计算">3.2. 进阶：将列拼接为矩阵进行计算</a></li><li class="topic-item"><a href="#33-%E9%AB%98%E6%80%A7%E8%83%BD-1tsdb-%E5%AD%98%E5%82%A8%E5%92%8C%E8%AE%A1%E7%AE%97" data-tocid="33-高性能-1tsdb-存储和计算">3.3. 高性能 1：TSDB 存储和计算</a></li><li class="topic-item"><a href="#34-%E9%AB%98%E6%80%A7%E8%83%BD-2%E5%9C%A8-tsdb-%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%95%B0%E7%BB%84%E5%90%91%E9%87%8F%E5%AD%98%E5%82%A8%E5%92%8C%E8%AE%A1%E7%AE%97" data-tocid="34-高性能-2在-tsdb-中使用数组向量存储和计算">3.4. 高性能 2：在 TSDB 中使用数组向量存储和计算</a></li></ul></li><li class="topic-item"><a href="#4-olap-%E5%88%B0-tsdb-%E7%9A%84%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87%E5%8E%9F%E5%9B%A0" data-tocid="4-olap-到-tsdb-的性能提升原因">4. OLAP 到 TSDB 的性能提升原因</a><ul><li class="topic-item"><a href="#41-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%8C%BA%E6%96%B9%E6%B3%95" data-tocid="41-数据库分区方法">4.1. 数据库分区方法</a></li><li class="topic-item"><a href="#42-%E6%95%B0%E6%8D%AE%E8%A1%A8%E5%88%9B%E5%BB%BA%E6%96%B9%E6%B3%95" data-tocid="42-数据表创建方法">4.2. 数据表创建方法</a></li><li class="topic-item"><a href="#43-olap-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E4%B8%8E-tsdb-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%9A%84%E5%B7%AE%E5%BC%82" data-tocid="43-olap-存储引擎与-tsdb-存储引擎的差异">4.3. OLAP 存储引擎与 TSDB 存储引擎的差异</a></li><li class="topic-item"><a href="#44-%E5%B0%8F%E7%BB%93" data-tocid="44-小结">4.4. 小结</a></li></ul></li><li class="topic-item"><a href="#5-%E6%80%BB%E7%BB%93" data-tocid="5-总结">5. 总结</a></li></ul></div>
	                        	
                        	</div>
                        </nav>
                    
                </div>
            </div>
            
            
            
        </div> 
        <footer class="navbar navbar-default wh_footer">
  <div class=" footer-container mx-auto ">
<title>Copyright</title><p><b> ©2024 浙江智臾科技有限公司 浙ICP备18048711号-3</b></p>
  </div>
</footer>
        
        <div id="go2top" class="d-print-none">
            <span class="oxy-icon oxy-icon-up"></span>
        </div>
        
        <div id="modal_img_large" class="modal">
            <span class="close oxy-icon oxy-icon-remove"></span>
            <div id="modal_img_container"></div>
            <div id="caption"></div>
        </div>
        
        
        
    </body>
</html>